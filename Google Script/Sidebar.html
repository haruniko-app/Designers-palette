<!DOCTYPE html>
<html>
    <head>
        <base target="_top">
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet">
        <style>
      body { font-family: 'Roboto', sans-serif; font-size: 13px; color: #202124; margin: 0; padding: 0; background-color: #fff; display: flex; flex-direction: column; height: 100vh; }

      /* Preview */
      .preview-container { background-color: #f8f9fa; padding: 20px; display: flex; justify-content: center; align-items: center; position: relative; min-height: 200px; border-radius: 8px 8px 0 0; border-bottom: 1px solid #dadce0; }
      canvas { max-width: 100%; max-height: 250px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); background-color: #fff; background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%); background-size: 20px 20px; display: none; }

      /* Placeholder */
      #placeholder { text-align: center; color: #5f6368; font-size: 13px; line-height: 1.6; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-color: #f8f9fa; z-index: 5; border-radius: 8px 8px 0 0; }
      .placeholder-icon { width: 48px; height: 48px; margin-bottom: 10px; opacity: 0.5; fill: #5f6368; }

      /* Loading */
      #loadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; display: none; }
      .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1a73e8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loading-text { font-size: 12px; font-weight: 500; color: #1a73e8; }

      .scroll-container { flex: 1; overflow-y: auto; background: #f1f3f4; padding: 0; }

      .main-content { opacity: 1; pointer-events: auto; transition: opacity 0.3s; background: #fff; border-radius: 0 0 8px 8px; margin: 0; }

      .standalone-content { background: #fff; border-radius: 8px; margin: 10px 0 0 0; }

      .section { border-bottom: 1px solid #dadce0; transition: transform 0.15s, box-shadow 0.15s; }
      .section.dragging { opacity: 0.8; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; background: #fff; }
      .section.drag-over { border-top: 2px solid #1a73e8; }
      .section-header { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; }
      .section-header:hover { background-color: #f1f3f4; }
      .section-title { font-weight: 500; flex: 1; font-size: 14px; color: #202124; }
      .drag-handle { width: 16px; height: 16px; fill: #bdc1c6; margin-right: 6px; cursor: grab; flex-shrink: 0; }
      .drag-handle:hover { fill: #5f6368; }
      .drag-handle:active { cursor: grabbing; }
      .arrow-icon { width: 20px; height: 20px; fill: #5f6368; margin-right: 10px; transform: rotate(-90deg); transition: transform 0.2s; }
      .section.open .arrow-icon { transform: rotate(0deg); }
      .section-content { display: none; padding: 8px 16px 16px 16px; overflow: hidden; }
      .section.open .section-content { display: block; }

      .control-label { display: flex; justify-content: space-between; color: #5f6368; font-size: 12px; margin-bottom: 6px; }
      .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .input-wrapper { display: flex; align-items: center; border-bottom: 0; padding-bottom: 0; }
      input[type="number"] { border: 1px solid #dadce0; border-radius: 4px; outline: none; width: 100%; font-size: 12px; background: #fff; color: #1a73e8; font-weight: 500; padding: 6px 8px; box-sizing: border-box; }
      input[type="number"]:focus { border-color: #1a73e8; }
      input[type="range"] { width: 100%; accent-color: #1a73e8; margin-top: 8px; cursor: pointer; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; background: #dadce0; outline: none; }
      input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #fff; border: 2px solid #333; border-radius: 50%; cursor: pointer; }
      textarea { border: 1px solid #dadce0; border-radius: 4px; padding: 8px; height: 60px; resize: none; margin-top: 5px; width: 100%; box-sizing: border-box; font-family: inherit; }

      .action-btn { background: #fff; border: 1px solid #dadce0; color: #1a73e8; padding: 10px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: 500; font-size: 13px; }
      .action-btn:hover { background: #f8fbff; border-color: #c2dbfe; }
      .action-btn:disabled { color: #bdc1c6; border-color: #f1f3f4; cursor: not-allowed; background: #f8f9fa; }
      .primary-btn { background: #1a73e8; color: #fff; border: none; }
      .primary-btn:hover { background: #1765cc; }
      .btn-group { display: flex; border: 1px solid #dadce0; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
      .btn-opt { flex: 1; text-align: center; padding: 8px; cursor: pointer; font-size: 11px; background: #fff; border-right: 1px solid #dadce0; color: #5f6368; }
      .btn-opt:last-child { border-right: none; }
      .btn-opt.selected { background-color: #e8f0fe; color: #1967d2; font-weight: 500; }
      .btn-group-vertical { display: flex; flex-direction: column; border: 1px solid #dadce0; border-radius: 4px; overflow: hidden; margin-bottom: 10px;}
      .btn-row { display: flex; width: 100%; border-bottom: 1px solid #dadce0; }
      .btn-row:last-child { border-bottom: none; }
      .btn-group-vertical .btn-opt { border-bottom: none; border-right: 1px solid #dadce0; }
      .btn-group-vertical .btn-opt:last-child { border-right: none; }

      .footer { padding: 16px; border-top: 1px solid #dadce0; display: flex; justify-content: flex-end; background: #fff; }
      .reload-icon-btn { position: absolute; top: 10px; right: 10px; background: white; border: 1px solid #dadce0; border-radius: 50%; width: 32px; height: 32px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .reload-icon-btn:hover { background: #f1f3f4; }
      .download-icon-btn { position: absolute; top: 50px; right: 10px; background: white; border: 1px solid #1a73e8; border-radius: 50%; width: 32px; height: 32px; display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .download-icon-btn:hover { background: #e8f0fe; }
      .download-icon-btn.active { display: flex; }
      .info-box { background-color: #e8f0fe; border: 1px solid #d2e3fc; color: #185abc; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; line-height: 1.4; }
      .retry-group { display: flex; gap: 10px; margin-top: 10px; }
      .retry-btn { flex: 1; background: #f1f3f4; color: #333; border: 1px solid #dadce0; }
      .confirm-btn { flex: 1; background: #e6f4ea; color: #188038; border: 1px solid #188038; }
      .control-row { margin-bottom: 0; }
      .control-row + .control-row { margin-top: 8px; }
      .unit { margin-left: 4px; font-size: 11px; color: #5f6368; }
      input.color-input { width: 55px !important; flex-shrink: 0; padding: 4px 6px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right; color: #1a73e8; font-weight: 500; }
      input.color-input:focus { outline: none; border-color: #1a73e8; }
      .val-disp { font-weight: bold; color: #1a73e8; cursor: pointer; }
      .val-disp:hover { text-decoration: underline; }
      .divider { border: none; border-top: 1px dashed #dadce0; margin: 15px 0; }
      #errorMessage { color: #d93025; margin-top: 10px; display: none; font-weight: 500; }

      /* ========================================
         カラーターゲット切り替えUI
         ======================================== */
      .color-target-switcher { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding: 8px; background: #f8f9fa; border-radius: 12px; }
      .color-target-group { display: flex; gap: 6px; }
      .color-target-group.shape-targets { padding-right: 8px; border-right: 1px solid #dadce0; }
      .color-target { width: 40px; height: 40px; border-radius: 8px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; background: #fff; border: 2px solid transparent; }
      .color-target:hover { background: #f1f3f4; }
      .color-target.active { border-color: #1a73e8; background: #e8f0fe; }
      .color-target.fill-target .color-preview { width: 24px; height: 24px; border-radius: 4px; background: #1a73e8; border: 1px solid rgba(0,0,0,0.1); }
      .color-target.fill-target.none .color-preview { background: #fff; border: 1px solid #dadce0; position: relative; overflow: hidden; }
      .color-target.fill-target.none .color-preview::after { content: ''; position: absolute; top: 50%; left: -20%; width: 140%; height: 2px; background: #e53935; transform: rotate(-45deg); }
      .color-target.stroke-target .color-preview { width: 22px; height: 22px; border-radius: 5px; background: #fff; border: 3px solid #000; }
      .color-target.stroke-target.none .color-preview { border-color: #e0e0e0; position: relative; overflow: hidden; }
      .color-target.stroke-target.none .color-preview::after { content: ''; position: absolute; top: 50%; left: -20%; width: 140%; height: 2px; background: #e53935; transform: rotate(-45deg); }
      .color-target.text-target { flex-direction: column; gap: 2px; }
      .color-target.text-target .text-icon { font-size: 18px; font-weight: 700; font-family: 'Google Sans', Arial, sans-serif; color: #000; line-height: 1; }
      .color-target.text-target .color-indicator { width: 20px; height: 4px; border-radius: 2px; background: #000; }
      .color-target.highlight-target { overflow: hidden; }
      .color-target.highlight-target .highlight-preview { width: 28px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 3px; background: transparent; border: 1px solid #dadce0; }
      .color-target.highlight-target .text-icon { font-size: 14px; font-weight: 600; font-family: Arial, sans-serif; color: #333; }
      .color-target.highlight-target.none .highlight-preview { background: #fff; }
      .color-target.highlight-target.none .highlight-preview::after { content: ''; position: absolute; width: 28px; height: 2px; background: #e53935; transform: rotate(-45deg); }
      .color-target::after { content: attr(data-label); position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%); font-size: 9px; color: #5f6368; white-space: nowrap; }

      /* クイックカラー + スポイト */
      .quick-colors { display: flex; gap: 4px; margin-top: 8px; margin-bottom: 16px; }
      .eyedropper-btn { width: 24px; height: 24px; border: 1px solid #dadce0; border-radius: 4px; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 8px; }
      .eyedropper-btn:hover { border-color: #1a73e8; background: #e8f0fe; }
      .eyedropper-btn.active { border-color: #1a73e8; background: #1a73e8; }
      .eyedropper-btn.active svg { fill: #fff; }
      .eyedropper-btn svg { width: 14px; height: 14px; fill: #5f6368; }
      .quick-color { width: 18px; height: 18px; border: 1px solid #dadce0; cursor: pointer; border-radius: 2px; }
      .quick-color:hover { border-color: #1a73e8; }
      .quick-color.none-btn { background: linear-gradient(to top right, transparent calc(50% - 1px), #d93025 calc(50% - 1px), #d93025 calc(50% + 1px), transparent calc(50% + 1px)), #fff; }
      .quick-color.white-btn { background: #fff; }
      .quick-color.black-btn { background: #000; border-color: #000; }

      /* スウォッチパレット */
      .swatch-section { margin-bottom: 16px; }
      .swatch-label { font-size: 11px; color: #5f6368; margin-bottom: 6px; }
      .swatch-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; }
      .swatch { width: 100%; aspect-ratio: 1; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; border-radius: 2px; transition: transform 0.1s; box-sizing: border-box; }
      .swatch:hover { transform: scale(1.15); z-index: 10; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .recent-colors { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; min-height: 24px; }
      .recent-color { width: 100%; aspect-ratio: 1; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; border-radius: 2px; box-sizing: border-box; }
      .recent-color.empty { background: repeating-linear-gradient(45deg, #f5f5f5, #f5f5f5 2px, #e0e0e0 2px, #e0e0e0 4px); cursor: default; }

      /* カラースペクトラム */
      .spectrum-section { margin-bottom: 16px; }
      .spectrum-container { position: relative; margin-bottom: 10px; }
      #colorSpectrum { width: 100%; height: 120px; border-radius: 4px; cursor: crosshair; display: block; }
      .spectrum-cursor { position: absolute; width: 12px; height: 12px; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 2px rgba(0,0,0,0.5); pointer-events: none; transform: translate(-50%, -50%); }
      #hueSlider { width: 100%; height: 16px; border-radius: 8px; -webkit-appearance: none; appearance: none; background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); outline: none; cursor: pointer; }
      #hueSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #fff; border: 2px solid #333; border-radius: 50%; cursor: pointer; }

      /* RGB スライダー */
      .rgb-section { margin-bottom: 16px; }
      .rgb-row { display: flex; align-items: center; margin-bottom: 8px; }
      .rgb-label { width: 20px; font-weight: 500; font-size: 12px; }
      .rgb-label.r { color: #d93025; }
      .rgb-label.g { color: #188038; }
      .rgb-label.b { color: #1a73e8; }
      .rgb-slider { flex: 1; margin: 0 10px; -webkit-appearance: none; appearance: none; height: 6px; border-radius: 3px; outline: none; cursor: pointer; }
      .rgb-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #fff; border: 2px solid #333; border-radius: 50%; cursor: pointer; }
      #sliderR { background: linear-gradient(to right, #000, #ff0000); }
      #sliderG { background: linear-gradient(to right, #000, #00ff00); }
      #sliderB { background: linear-gradient(to right, #000, #0000ff); }
      input.rgb-value { width: 55px !important; text-align: center; padding: 4px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; flex-shrink: 0; flex-grow: 0; }

      /* 色調補正スライダー */
      .adjust-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .adjust-label { width: 70px; font-size: 12px; color: #5f6368; flex-shrink: 0; }
      .adjust-row input[type="range"] { flex: 1; margin: 0; }

      /* HEX 入力 */
      .hex-section { display: flex; align-items: center; gap: 8px; }
      .hex-preview { width: 32px; height: 32px; border: 1px solid #dadce0; border-radius: 4px; }
      .hex-input-wrapper { display: flex; align-items: center; border: 1px solid #dadce0; border-radius: 4px; padding: 4px 8px; }
      .hex-input-wrapper span { color: #5f6368; }
      #hexInput { border: none; outline: none; width: 70px; font-family: monospace; font-size: 13px; text-transform: uppercase; }
      .apply-btn { flex: 1; background: #1a73e8; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 13px; }
      .apply-btn:hover { background: #1765cc; }

      /* 枠線スタイル */
      .stroke-row { display: flex; align-items: center; margin-bottom: 10px; }
      .stroke-label { width: 50px; font-size: 12px; color: #5f6368; }
      input.stroke-weight-input { width: 55px !important; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: center; flex-shrink: 0; }
      .stroke-weight-unit { margin-left: 4px; font-size: 11px; color: #5f6368; }
      .stroke-dash-options { display: flex; gap: 4px; flex: 1; }
      .dash-option { flex: 1; height: 32px; border: 1px solid #dadce0; border-radius: 4px; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
      .dash-option:hover { border-color: #1a73e8; }
      .dash-option.selected { border-color: #1a73e8; background: #e8f0fe; }
      .dash-option svg { width: 100%; height: 8px; }
      .dash-option svg line { stroke: #333; stroke-width: 2; }

      /* サイズセクション */
      .size-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
      .size-label { flex-shrink: 0; width: 30px; font-size: 12px; color: #5f6368; }
      .size-input { width: 70px; flex-shrink: 0; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right; }
      .size-unit { flex-shrink: 0; font-size: 11px; color: #5f6368; }
      .size-apply-btn { background: #1a73e8; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; }
      .size-apply-btn:hover { background: #1765cc; }
      .size-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
      .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #5f6368; cursor: pointer; }
      .checkbox-label input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }

      /* アスペクト比ボタン */
      .aspect-section { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0; }
      .aspect-label { font-size: 11px; color: #5f6368; margin-bottom: 8px; }
      .aspect-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
      .aspect-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px 4px; border: 1px solid #dadce0; border-radius: 4px; background: #fff; cursor: pointer; min-height: 44px; }
      .aspect-btn:hover { border-color: #1a73e8; background: #f8f9fa; }
      .aspect-btn .aspect-icon { display: flex; align-items: center; justify-content: center; margin-bottom: 2px; }
      .aspect-btn .aspect-icon svg { fill: #5f6368; }
      .aspect-btn:hover .aspect-icon svg { fill: #1a73e8; }
      .aspect-btn .aspect-text { font-size: 9px; color: #5f6368; white-space: nowrap; }
      .aspect-btn:hover .aspect-text { color: #1a73e8; }

      /* 間隔セクション */
      .spacing-row { display: flex; align-items: center; margin-bottom: 12px; }
      .spacing-label { flex-shrink: 0; font-size: 12px; color: #5f6368; margin-right: 8px; }
      .spacing-input { width: 60px; flex-shrink: 0; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right; }
      .spacing-unit { margin-left: 4px; font-size: 11px; color: #5f6368; }
      .spacing-buttons { display: flex; gap: 8px; }

      /* 複製セクション */
      .duplicate-row { display: flex; align-items: center; margin-bottom: 10px; }
      .duplicate-label { width: 40px; font-size: 12px; color: #5f6368; }
      .duplicate-input { width: 70px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right; }
      .duplicate-unit { margin-left: 4px; font-size: 11px; color: #5f6368; }
      .duplicate-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }

      /* 回転・反転/順序/グループ共通 */
      .transform-buttons, .order-buttons, .group-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

      /* テキストセクション */
      .text-row { display: flex; align-items: center; margin-bottom: 10px; }
      .text-label { width: 50px; font-size: 12px; color: #5f6368; flex-shrink: 0; }
      .font-select { flex: 1; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; background: #fff; cursor: pointer; }
      .font-select:focus { outline: none; border-color: #1a73e8; }
      input.font-size-input { width: 55px !important; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: center; flex-shrink: 0; }
      .font-size-unit { margin-left: 4px; font-size: 11px; color: #5f6368; }
      .line-spacing-btn { padding: 4px 8px; font-size: 11px; color: #5f6368; border: 1px solid #dadce0; border-radius: 4px; background: #fff; cursor: pointer; transition: all 0.15s; }
      .line-spacing-btn:hover { border-color: #1a73e8; background: #f1f3f4; color: #1a73e8; }
      .text-style-buttons { display: flex; gap: 4px; }
      .text-style-btn { width: 32px; height: 32px; border: 1px solid #dadce0; border-radius: 4px; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; transition: all 0.15s; }
      .text-style-btn:hover { border-color: #1a73e8; background: #f1f3f4; }
      .text-style-btn.active { border-color: #1a73e8; background: #e8f0fe; color: #1a73e8; }
      .text-style-btn.bold { font-weight: 700; }
      .text-style-btn.italic { font-style: italic; }
      .text-style-btn.underline { text-decoration: underline; }
      .text-style-btn.strikethrough { text-decoration: line-through; }

      /* 共通ボタン */
      .icon-btn { display: flex; align-items: center; gap: 4px; padding: 6px 10px; }
      .icon-btn svg { flex-shrink: 0; }
      .wide-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; }

      /* トースト通知 */
      .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #323232; color: #fff; padding: 10px 20px; border-radius: 4px; font-size: 13px; z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; max-width: 280px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
      .toast.show { opacity: 1; }
      .toast.error { background: #d93025; }
      .toast.success { background: #188038; }
    </style>
    </head>
    <body>
        <div class="scroll-container">
        <div class="preview-container">
            <div id="placeholder">
                <svg class="placeholder-icon" viewBox="0 0 24 24"
                    style="width:48px;height:48px;fill:#dadce0;"><path
                        d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" /></svg>
                <div style="margin-top:10px;"
                    id="placeholderText" data-i18n="placeholder_title">スライド上の画像を選択してください</div>
                <div id="errorMessage"></div>
            </div>

            <canvas id="previewCanvas"></canvas>
            <div id="loadingOverlay"><div class="spinner"></div><div
                    class="loading-text" id="loadingText">読み込み中...</div></div>
            <div class="reload-icon-btn" onclick="resetAndLoad()"
                title="リセット" data-i18n-title="tip_reset"><svg width="18" height="18" viewBox="0 0 24 24"
                    fill="#5f6368"><path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" /></svg></div>
            <div class="download-icon-btn" id="downloadBtn" onclick="downloadImage()"
                title="画像をダウンロード" data-i18n-title="tip_download"><svg width="18" height="18" viewBox="0 0 24 24"
                    fill="#1a73e8"><path
                        d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" /></svg></div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="section" id="sec-crop" data-group="image">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-crop')"><path d="M7 10l5 5 5-5z" /></svg>
                    <span class="section-title" onclick="toggleSection('sec-crop')" data-i18n="sec_crop">トリミング確定</span>
                </div>
                <div class="section-content">
                    <div
                        class="info-box" data-i18n="info_crop">現在のトリミング範囲で画像を切り抜き、見えていない部分を削除します。</div>
                    <button class="action-btn" id="cropBtn"
                        onclick="performCrop()" disabled data-i18n="btn_crop">トリミングを実行して確定</button>
                </div>
            </div>
            <div class="section" id="sec-extend" data-group="image">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-extend')"><path d="M7 10l5 5 5-5z" /></svg>
                    <span class="section-title" onclick="toggleSection('sec-extend')" data-i18n="sec_extend">AI画像拡張</span>
                </div>
                <div class="section-content">
                    <div class="info-box" data-i18n="info_extend">AIを使用して画像の周囲を描き足します。</div>
                    <div class="adjust-row">
                        <span class="adjust-label" data-i18n="label_width">横</span>
                        <input type="range" id="rangeW" min="0" max="100" value="0" oninput="syncNum('w', this.value)">
                        <input type="number" class="color-input" id="numW" value="0" min="0" max="100" oninput="syncSlider('w', this.value)">
                        <span class="unit">%</span>
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" data-i18n="label_height">縦</span>
                        <input type="range" id="rangeH" min="0" max="100" value="0" oninput="syncNum('h', this.value)">
                        <input type="number" class="color-input" id="numH" value="0" min="0" max="100" oninput="syncSlider('h', this.value)">
                        <span class="unit">%</span>
                    </div>
                    <button class="action-btn" id="generateBtn"
                        onclick="callCloudAI('extend')" disabled data-i18n="btn_generate">生成を実行</button>
                    <div id="postGenButtons" class="retry-group"
                        style="display:none;">
                        <button class="action-btn retry-btn"
                            onclick="callCloudAI('extend')" data-i18n="btn_regenerate">再生成</button>
                    </div>
                </div>
            </div>
            <div class="section" id="sec-upscale" data-group="image">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-upscale')"><path d="M7 10l5 5 5-5z" /></svg>
                    <span class="section-title" onclick="toggleSection('sec-upscale')" data-i18n="sec_upscale">AI高画質化</span>
                </div>
                <div class="section-content">
                    <div
                        class="info-box" data-i18n="info_upscale">AIを使用して画像の解像度を2倍に高め、ぼやけた輪郭をくっきりと補正します。</div>
                    <button class="action-btn" id="upscaleBtn"
                        onclick="callCloudAI('upscale')" disabled data-i18n="btn_upscale">高画質化を実行</button>
                </div>
            </div>
            <div class="section" id="sec-color" data-group="image">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-color')"><path d="M7 10l5 5 5-5z" /></svg>
                    <span class="section-title" onclick="toggleSection('sec-color')" data-i18n="sec_color">色調調整</span>
                </div>
                <div class="section-content">
                    <div class="adjust-row">
                        <span class="adjust-label" data-i18n="label_brightness">明るさ</span>
                        <input type="range" id="brightnessRange" min="0" max="200" value="100" oninput="syncColor('brightness')">
                        <input type="number" class="color-input" id="val_brightness" value="100" min="0" max="200" oninput="syncColorFromInput('brightness')">
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" style="font-size:11px;letter-spacing:-0.5px;" data-i18n="label_contrast">コントラスト</span>
                        <input type="range" id="contrastRange" min="0" max="200" value="100" oninput="syncColor('contrast')">
                        <input type="number" class="color-input" id="val_contrast" value="100" min="0" max="200" oninput="syncColorFromInput('contrast')">
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" data-i18n="label_saturation">彩度</span>
                        <input type="range" id="saturateRange" min="0" max="200" value="100" oninput="syncColor('saturate')">
                        <input type="number" class="color-input" id="val_saturate" value="100" min="0" max="200" oninput="syncColorFromInput('saturate')">
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" data-i18n="label_hue">色相</span>
                        <input type="range" id="hueRange" min="0" max="360" value="0" oninput="syncColor('hue')">
                        <input type="number" class="color-input" id="val_hue" value="0" min="0" max="360" oninput="syncColorFromInput('hue')">
                    </div>
                    <hr class="divider">
                    <div class="adjust-row">
                        <span class="adjust-label" style="color:#d93025;" data-i18n="label_red">赤</span>
                        <input type="range" id="colorRRange" min="-100" max="100" value="0" oninput="syncColor('colorR')">
                        <input type="number" class="color-input" id="val_colorR" value="0" min="-100" max="100" oninput="syncColorFromInput('colorR')">
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" style="color:#188038;" data-i18n="label_green">緑</span>
                        <input type="range" id="colorGRange" min="-100" max="100" value="0" oninput="syncColor('colorG')">
                        <input type="number" class="color-input" id="val_colorG" value="0" min="-100" max="100" oninput="syncColorFromInput('colorG')">
                    </div>
                    <div class="adjust-row">
                        <span class="adjust-label" style="color:#1a73e8;" data-i18n="label_blue">青</span>
                        <input type="range" id="colorBRange" min="-100" max="100" value="0" oninput="syncColor('colorB')">
                        <input type="number" class="color-input" id="val_colorB" value="0" min="-100" max="100" oninput="syncColorFromInput('colorB')">
                    </div>
                </div>
            </div>
            <div class="section" id="sec-effect" data-group="image">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-effect')"><path d="M7 10l5 5 5-5z" /></svg>
                    <span class="section-title" onclick="toggleSection('sec-effect')" data-i18n="sec_effect">エフェクト</span>
                </div>
                <div class="section-content">
                    <div class="btn-group-vertical">
                        <div class="btn-row"><div class="btn-opt selected"
                                onclick="setEffect('none', this)" data-i18n="effect_none">なし</div><div
                                class="btn-opt"
                                onclick="setEffect('blur', this)" data-i18n="effect_blur">ぼかし</div><div
                                class="btn-opt"
                                onclick="setEffect('pixelate', this)" data-i18n="effect_pixelate">モザイク</div></div>
                        <div class="btn-row"><div class="btn-opt"
                                onclick="setEffect('grayscale', this)" data-i18n="effect_grayscale">モノクロ</div><div
                                class="btn-opt"
                                onclick="setEffect('sepia', this)" data-i18n="effect_sepia">セピア</div><div
                                class="btn-opt"
                                onclick="setEffect('vignette', this)" data-i18n="effect_vignette">周辺減光</div></div>
                    </div>
                    <div class="control-row" style="margin-top:10px;"><div
                            class="control-label"><span data-i18n="label_intensity">強度</span> <span id="effectValLabel"
                                style="float:right; color:#1a73e8;">0</span></div><div
                            class="input-wrapper"><input type="range"
                                id="effectRange" min="0" max="100" value="0"
                                oninput="updatePreview()"></div></div>
                </div>
            </div>
            <div style="padding: 16px; border-top: 0;">
                <button class="action-btn primary-btn" id="applyBtn" onclick="applyToSlide()" disabled style="margin-top: 0;" data-i18n="btn_apply">スライドに適用</button>
            </div>
        </div>

        <div class="standalone-content" id="utilityContent">
            <!-- カラーセクション -->
            <div class="section" id="sec-color-panel" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-color-panel')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-color-panel')" data-i18n="sec_color_panel">カラー</span>
                </div>
                <div class="section-content">
                    <div class="color-target-switcher">
                        <div class="color-target-group shape-targets">
                            <div class="color-target fill-target active" id="fillBox" onclick="setActiveTarget('fill')" data-label="塗り" data-i18n-label="target_fill">
                                <div class="color-preview" id="fillPreview"></div>
                            </div>
                            <div class="color-target stroke-target" id="strokeBox" onclick="setActiveTarget('stroke')" data-label="線" data-i18n-label="target_stroke">
                                <div class="color-preview" id="strokePreview"></div>
                            </div>
                        </div>
                        <div class="color-target-group text-targets">
                            <div class="color-target text-target" id="textColorTarget" onclick="setActiveTarget('text')" data-label="文字" data-i18n-label="target_text">
                                <span class="text-icon">A</span>
                                <div class="color-indicator" id="textColorBar"></div>
                            </div>
                            <div class="color-target highlight-target none" id="highlightTarget" onclick="setActiveTarget('highlight')" data-label="蛍光ペン" data-i18n-label="target_highlight">
                                <div class="highlight-preview" id="highlightBg">
                                    <span class="text-icon">A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="quick-colors">
                        <div class="quick-color none-btn" onclick="setNone()" title="なし" data-i18n-title="tip_none"></div>
                        <div class="quick-color white-btn" onclick="setQuickColor('#FFFFFF')" title="白" data-i18n-title="tip_white"></div>
                        <div class="quick-color black-btn" onclick="setQuickColor('#000000')" title="黒" data-i18n-title="tip_black"></div>
                        <div class="eyedropper-btn" id="eyedropperBtn" onclick="toggleEyedropper()" title="スポイト（選択要素から色を取得）" data-i18n-title="tip_eyedropper">
                            <svg viewBox="0 0 24 24"><path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-3.12 3.12-1.41-1.41-1.42 1.41 1.42 1.42-8.32 8.32A2 2 0 003.46 18l-.71 2.12a.5.5 0 00.63.63L5.5 20.04a2 2 0 001.79-.65l8.32-8.32 1.41 1.41 1.41-1.41-1.41-1.41 3.12-3.12a1 1 0 00.07-1.41z"/></svg>
                        </div>
                    </div>
                    <div class="swatch-section">
                        <div class="swatch-label" data-i18n="label_recent_colors">最近使用したカラー</div>
                        <div class="recent-colors" id="recentColors"></div>
                    </div>
                    <div class="swatch-section">
                        <div class="swatch-label" data-i18n="label_color_palette">カラーパレット</div>
                        <div class="swatch-grid" id="swatchGrid"></div>
                    </div>
                    <div class="spectrum-section">
                        <div class="swatch-label" data-i18n="label_custom_color">カスタムカラー</div>
                        <div class="spectrum-container">
                            <canvas id="colorSpectrum" width="276" height="120"></canvas>
                            <div class="spectrum-cursor" id="spectrumCursor"></div>
                        </div>
                        <input type="range" id="hueSlider" min="0" max="360" value="0" oninput="updateHue(this.value)" onchange="addCurrentColorToRecent()">
                    </div>
                    <div class="rgb-section">
                        <div class="rgb-row">
                            <span class="rgb-label r">R</span>
                            <input type="range" class="rgb-slider" id="sliderR" min="0" max="255" value="26" oninput="updateFromRGB()" onchange="addCurrentColorToRecent()">
                            <input type="number" class="rgb-value" id="valueR" min="0" max="255" value="26" oninput="updateFromRGBInputs()" onchange="addCurrentColorToRecent()">
                        </div>
                        <div class="rgb-row">
                            <span class="rgb-label g">G</span>
                            <input type="range" class="rgb-slider" id="sliderG" min="0" max="255" value="115" oninput="updateFromRGB()" onchange="addCurrentColorToRecent()">
                            <input type="number" class="rgb-value" id="valueG" min="0" max="255" value="115" oninput="updateFromRGBInputs()" onchange="addCurrentColorToRecent()">
                        </div>
                        <div class="rgb-row">
                            <span class="rgb-label b">B</span>
                            <input type="range" class="rgb-slider" id="sliderB" min="0" max="255" value="232" oninput="updateFromRGB()" onchange="addCurrentColorToRecent()">
                            <input type="number" class="rgb-value" id="valueB" min="0" max="255" value="232" oninput="updateFromRGBInputs()" onchange="addCurrentColorToRecent()">
                        </div>
                        <div class="rgb-row">
                            <span class="rgb-label" style="color:#5f6368;">A</span>
                            <input type="range" class="rgb-slider" id="sliderA" min="0" max="100" value="100" oninput="updateAlphaUI()" onchange="applyCurrentColorWithAlpha()" style="background:linear-gradient(to right, transparent, #000);">
                            <input type="number" class="rgb-value" id="valueA" min="0" max="100" value="100" oninput="updateAlphaUI()" onchange="applyCurrentColorWithAlpha()">
                        </div>
                    </div>
                    <div class="hex-section">
                        <div class="hex-preview" id="hexPreview" style="background: #1a73e8;"></div>
                        <div class="hex-input-wrapper">
                            <span>#</span>
                            <input type="text" id="hexInput" value="1A73E8" maxlength="6" oninput="updateFromHex()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 枠線セクション -->
            <div class="section" id="sec-stroke" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-stroke')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-stroke')" data-i18n="sec_stroke">枠線</span>
                </div>
                <div class="section-content">
                    <div class="stroke-row">
                        <span class="stroke-label" data-i18n="label_thickness">太さ</span>
                        <input type="number" class="stroke-weight-input" id="strokeWeight" value="1" min="0" max="100" step="0.5" onchange="applyStrokeStyle()">
                        <span class="stroke-weight-unit">pt</span>
                    </div>
                    <div class="stroke-row" style="margin-bottom: 0;">
                        <span class="stroke-label" data-i18n="label_type">種類</span>
                        <div class="stroke-dash-options">
                            <div class="dash-option selected" data-dash="SOLID" onclick="setDashStyle('SOLID', this); applyStrokeStyle();" title="実線" data-i18n-title="tip_solid">
                                <svg viewBox="0 0 40 8"><line x1="0" y1="4" x2="40" y2="4"/></svg>
                            </div>
                            <div class="dash-option" data-dash="DASH" onclick="setDashStyle('DASH', this); applyStrokeStyle();" title="破線" data-i18n-title="tip_dash">
                                <svg viewBox="0 0 40 8"><line x1="0" y1="4" x2="40" y2="4" stroke-dasharray="8,4"/></svg>
                            </div>
                            <div class="dash-option" data-dash="DOT" onclick="setDashStyle('DOT', this); applyStrokeStyle();" title="点線" data-i18n-title="tip_dot">
                                <svg viewBox="0 0 40 8"><line x1="0" y1="4" x2="40" y2="4" stroke-dasharray="2,4"/></svg>
                            </div>
                            <div class="dash-option" data-dash="DASH_DOT" onclick="setDashStyle('DASH_DOT', this); applyStrokeStyle();" title="一点鎖線" data-i18n-title="tip_dash_dot">
                                <svg viewBox="0 0 40 8"><line x1="0" y1="4" x2="40" y2="4" stroke-dasharray="8,4,2,4"/></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- テキストセクション -->
            <div class="section" id="sec-text" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-text')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-text')" data-i18n="sec_text">テキスト</span>
                </div>
                <div class="section-content">
                    <div class="text-row">
                        <span class="text-label" data-i18n="label_font">フォント</span>
                        <select class="font-select" id="fontSelect" onchange="applyFont()">
                            <option value="Arial">Arial</option>
                            <option value="Arial Black">Arial Black</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Impact">Impact</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Trebuchet MS">Trebuchet MS</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Noto Sans JP">Noto Sans JP</option>
                            <option value="Noto Serif JP">Noto Serif JP</option>
                            <option value="M PLUS 1p">M PLUS 1p</option>
                            <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
                            <option value="Kosugi Maru">Kosugi Maru</option>
                            <option value="Sawarabi Gothic">Sawarabi Gothic</option>
                        </select>
                    </div>
                    <div class="text-row">
                        <span class="text-label" data-i18n="label_size">サイズ</span>
                        <input type="number" class="font-size-input" id="fontSizeInput" value="14" min="1" max="400" step="1" onchange="applyFontSize()">
                        <span class="font-size-unit">pt</span>
                    </div>
                    <div class="text-row">
                        <span class="text-label" data-i18n="label_style">スタイル</span>
                        <div class="text-style-buttons">
                            <button class="text-style-btn bold" id="btnBold" onclick="toggleTextStyle('bold')">B</button>
                            <button class="text-style-btn italic" id="btnItalic" onclick="toggleTextStyle('italic')">I</button>
                            <button class="text-style-btn underline" id="btnUnderline" onclick="toggleTextStyle('underline')">U</button>
                            <button class="text-style-btn strikethrough" id="btnStrikethrough" onclick="toggleTextStyle('strikethrough')">S</button>
                        </div>
                    </div>
                    <!-- 行間・段落間隔 -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 8px;" data-i18n="label_paragraph">行間・段落</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#5f6368"><path d="M6 7h2.5L5 3.5 1.5 7H4v10H1.5L5 20.5 8.5 17H6V7zm4-2v2h12V5H10zm0 14h12v-2H10v2zm0-6h12v-2H10v2z"/></svg>
                            <span style="font-size: 11px; color: #5f6368; width: 35px;" data-i18n="label_line_spacing">行間</span>
                            <input type="number" id="lineSpacing" value="1" min="0.5" max="5" step="0.1" style="width: 55px; padding: 5px 6px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;" onchange="applyLineSpacing()">
                            <div style="display: flex; gap: 4px;">
                                <div class="line-spacing-btn" onclick="setLineSpacing(1)" title="1">1</div>
                                <div class="line-spacing-btn" onclick="setLineSpacing(1.15)" title="1.15">1.15</div>
                                <div class="line-spacing-btn" onclick="setLineSpacing(1.5)" title="1.5">1.5</div>
                                <div class="line-spacing-btn" onclick="setLineSpacing(2)" title="2">2</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#5f6368" style="flex-shrink: 0;"><path d="M10 5h12v2H10V5zm0 12h12v2H10v-2zm-6 0h2v2H4v-2zm0-12h2v2H4V5zm0 6h2v2H4v-2zm6 0h12v2H10v-2z"/></svg>
                            <span style="font-size: 10px; color: #5f6368; white-space: nowrap;" data-i18n="label_before_para">段落前</span>
                            <input type="number" id="spaceBefore" value="0" min="0" max="100" step="1" style="width: 40px; padding: 4px; border: 1px solid #dadce0; border-radius: 4px; font-size: 11px; text-align: right;" onchange="applyParagraphSpacing()">
                            <span style="font-size: 10px; color: #5f6368;">pt</span>
                            <span style="font-size: 10px; color: #5f6368; white-space: nowrap; margin-left: 8px;" data-i18n="label_after_para">段落後</span>
                            <input type="number" id="spaceAfter" value="0" min="0" max="100" step="1" style="width: 40px; padding: 4px; border: 1px solid #dadce0; border-radius: 4px; font-size: 11px; text-align: right;" onchange="applyParagraphSpacing()">
                            <span style="font-size: 10px; color: #5f6368;">pt</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 整列セクション（間隔をマージ） -->
            <div class="section" id="sec-align" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-align')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-align')" data-i18n="sec_align">整列</span>
                </div>
                <div class="section-content">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #5f6368;" data-i18n="label_reference">基準:</span>
                        <select id="alignReferenceType" style="flex: 1; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; background: #fff;">
                            <option value="slide" data-i18n="opt_slide">スライド</option>
                            <option value="first" data-i18n="opt_first">最初に選択した要素</option>
                            <option value="last" data-i18n="opt_last">最後に選択した要素</option>
                            <option value="largest" data-i18n="opt_largest">最大の要素</option>
                            <option value="smallest" data-i18n="opt_smallest">最小の要素</option>
                        </select>
                    </div>
                    <div class="btn-group" style="margin-top:0; flex-wrap:wrap; gap:4px;">
                        <div class="btn-opt" onclick="alignElement('left')" style="display:flex;align-items:center;justify-content:center;flex-shrink:0;" title="左揃え">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 22H2V2h2v20zM22 7H6v3h16V7zm-6 7H6v3h10v-3z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="alignElement('center')" style="display:flex;align-items:center;justify-content:center;" title="中央揃え（横）">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2h2v20h-2V2zm10 5H3v3h18V7zm-4 7H7v3h10v-3z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="alignElement('right')" style="display:flex;align-items:center;justify-content:center;" title="右揃え">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2h2v20h-2V2zM2 10h16V7H2v3zm6 7h10v-3H8v3z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="alignElement('top')" style="display:flex;align-items:center;justify-content:center;" title="上揃え">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 2v2H2V2h20zM7 22h3V6H7v16zm7-6h3V6h-3v10z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="alignElement('middle')" style="display:flex;align-items:center;justify-content:center;" title="中央揃え（縦）">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 11v2H2v-2h20zM7 22h3V2H7v20zm7-4h3V6h-3v12z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="alignElement('bottom')" style="display:flex;align-items:center;justify-content:center;" title="下揃え">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 22H2v-2h20v2zM10 2H7v16h3V2zm7 6h-3v10h3V8z"/></svg>
                        </div>
                        <div style="width: 100%; height: 1px; background: #e0e0e0; margin:0;"></div>
                        <div class="btn-opt" onclick="distributeElement('horizontal')" style="display:flex;align-items:center;justify-content:center;" title="水平方向に均等配置">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 22H2V2h2v20zM22 2h-2v20h2V2zM13 7h-2v10h2V7zM9 7H7v10h2V7zm8 0h-2v10h2V7z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="distributeElement('vertical')" style="display:flex;align-items:center;justify-content:center;" title="垂直方向に均等配置">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 2v2H2V2h20zM2 22h20v-2H2v2zM7 13v-2h10v2H7zm0-6V5h10v2H7zm0 12v-2h10v2H7z"/></svg>
                        </div>
                    </div>
                    <div id="alignStatus" style="font-size:11px; color:#5f6368; margin-top:10px; text-align:center;"></div>
                    <!-- 均等間隔配置 -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 8px;" data-i18n="label_even_spacing">均等間隔配置</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #5f6368;" data-i18n="label_spacing">間隔</span>
                            <input type="number" id="spacingValue" value="10" min="0" step="1" style="width: 60px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                            <span style="font-size: 11px; color: #5f6368;">px</span>
                        </div>
                        <div class="spacing-buttons">
                            <button class="action-btn icon-btn" onclick="setHorizontalSpacing()">
                                <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 4h4v16H4V4zm12 0h4v16h-4V4zm-5 7h2v2h-2v-2z" fill="currentColor"/></svg>
                                <span data-i18n="btn_horizontal">水平</span>
                            </button>
                            <button class="action-btn icon-btn" onclick="setVerticalSpacing()">
                                <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 4h16v4H4V4zm0 12h16v4H4v-4zm7-5h2v2h-2v-2z" fill="currentColor"/></svg>
                                <span data-i18n="btn_vertical">垂直</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 図形セクション（サイズ + 回転・反転） -->
            <div class="section" id="sec-shape" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-shape')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-shape')" data-i18n="sec_shape">図形</span>
                </div>
                <div class="section-content">
                    <!-- 位置 (X/Y座標) -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #5f6368;">X</span>
                        <input type="number" id="positionX" value="0" step="1" onchange="applyPositionX()" style="width: 60px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 12px; color: #5f6368;">Y</span>
                        <input type="number" id="positionY" value="0" step="1" onchange="applyPositionY()" style="width: 60px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 11px; color: #5f6368;">px</span>
                    </div>
                    <!-- サイズ (幅/高さ) -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #5f6368;" data-i18n="label_width">幅</span>
                        <input type="number" id="sizeWidth" value="100" min="1" step="1" onchange="applyWidth()" style="width: 60px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 12px; color: #5f6368;" data-i18n="label_height">高さ</span>
                        <input type="number" id="sizeHeight" value="100" min="1" step="1" onchange="applyHeight()" style="width: 60px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 11px; color: #5f6368;">px</span>
                    </div>
                    <div class="size-row">
                        <label class="checkbox-label">
                            <input type="checkbox" id="keepAspectRatio" checked>
                            <span data-i18n="label_keep_aspect">縦横比を維持</span>
                        </label>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 8px;" data-i18n="label_match_size">サイズを揃える</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 12px; color: #5f6368;" data-i18n="label_reference">基準:</span>
                            <select id="alignReference" style="flex: 1; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; background: #fff;">
                                <option value="first" data-i18n="opt_first">最初に選択した要素</option>
                                <option value="last" data-i18n="opt_last">最後に選択した要素</option>
                                <option value="largest" data-i18n="opt_largest">最大の要素</option>
                                <option value="smallest" data-i18n="opt_smallest">最小の要素</option>
                            </select>
                        </div>
                        <div class="btn-group" style="margin-top: 0; flex-wrap: wrap; gap: 4px;">
                            <div class="btn-opt" onclick="matchWidth()" style="display:flex;align-items:center;justify-content:center;" title="幅を揃える" data-i18n-title="tip_match_width">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4H2v16h2V4zm18 0h-2v16h2V4zM9 7h6v4H9V7zm0 6h6v4H9v-4z"/></svg>
                            </div>
                            <div class="btn-opt" onclick="matchHeight()" style="display:flex;align-items:center;justify-content:center;" title="高さを揃える" data-i18n-title="tip_match_height">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 2v2h16V2H4zm0 18v2h16v-2H4zM7 9v6h4V9H7zm6 0v6h4V9h-4z"/></svg>
                            </div>
                            <div class="btn-opt" onclick="matchSize()" style="display:flex;align-items:center;justify-content:center;" title="サイズを揃える" data-i18n-title="tip_match_both">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4H2v16h2V4zm18 0h-2v16h2V4zM4 2v2h16V2H4zm0 18v2h16v-2H4zM8 8h8v8H8V8z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="aspect-section">
                        <div class="aspect-label" data-i18n="label_aspect_ratio">アスペクト比に変形</div>
                        <div class="aspect-grid">
                            <button class="aspect-btn" onclick="setAspectRatio(1, 1)" title="1:1 正方形">
                                <div class="aspect-icon"><svg width="20" height="20" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">1:1</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(4, 3)" title="4:3 スタンダード">
                                <div class="aspect-icon"><svg width="24" height="18" viewBox="0 0 24 18"><rect x="1" y="1" width="22" height="16" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">4:3</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(3, 4)" title="3:4 縦長">
                                <div class="aspect-icon"><svg width="18" height="24" viewBox="0 0 18 24"><rect x="1" y="1" width="16" height="22" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">3:4</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(16, 9)" title="16:9 ワイド">
                                <div class="aspect-icon"><svg width="28" height="16" viewBox="0 0 28 16"><rect x="1" y="1" width="26" height="14" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">16:9</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(9, 16)" title="9:16 縦長ワイド">
                                <div class="aspect-icon"><svg width="16" height="28" viewBox="0 0 16 28"><rect x="1" y="1" width="14" height="26" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">9:16</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(2, 1)" title="2:1 パノラマ">
                                <div class="aspect-icon"><svg width="28" height="14" viewBox="0 0 28 14"><rect x="1" y="1" width="26" height="12" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">2:1</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(1, 2)" title="1:2 縦長">
                                <div class="aspect-icon"><svg width="14" height="28" viewBox="0 0 14 28"><rect x="1" y="1" width="12" height="26" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">1:2</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(3, 2)" title="3:2 写真">
                                <div class="aspect-icon"><svg width="24" height="16" viewBox="0 0 24 16"><rect x="1" y="1" width="22" height="14" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">3:2</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(2, 3)" title="2:3 縦長写真">
                                <div class="aspect-icon"><svg width="16" height="24" viewBox="0 0 16 24"><rect x="1" y="1" width="14" height="22" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">2:3</span>
                            </button>
                            <button class="aspect-btn" onclick="setAspectRatio(21, 9)" title="21:9 シネマ">
                                <div class="aspect-icon"><svg width="32" height="14" viewBox="0 0 32 14"><rect x="1" y="1" width="30" height="12" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
                                <span class="aspect-text">21:9</span>
                            </button>
                        </div>
                    </div>
                    <!-- 回転・反転 -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #5f6368; margin-bottom: 8px;" data-i18n="label_rotation_flip">回転・反転</div>
                        <div class="btn-group" style="margin-top: 0; flex-wrap: wrap; gap: 4px;">
                            <div class="btn-opt" onclick="rotate90CW()" style="display:flex;align-items:center;justify-content:center;gap:2px;padding:4px 8px;" title="90° 右回転">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                                <span style="font-size:11px;">90</span>
                            </div>
                            <div class="btn-opt" onclick="rotate90CCW()" style="display:flex;align-items:center;justify-content:center;gap:2px;padding:4px 8px;" title="90° 左回転">
                                <span style="font-size:11px;">90</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" transform="scale(-1,1) translate(-24,0)"/></svg>
                            </div>
                            <div class="btn-opt" onclick="rotate180()" style="display:flex;align-items:center;justify-content:center;gap:2px;padding:4px 8px;" title="180° 回転">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5H5c0 3.87 3.13 7 7 7s7-3.13 7-7-3.13-7-7-7z"/></svg>
                                <span style="font-size:11px;">180</span>
                            </div>
                            <div class="btn-opt" onclick="flipHorizontal()" style="display:flex;align-items:center;justify-content:center;" title="左右反転">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15 21h2v-2h-2v2zm4-12h2V7h-2v2zM3 5v14c0 1.1.9 2 2 2h4v-2H5V5h4V3H5c-1.1 0-2 .9-2 2zm16-2v2h2c0-1.1-.9-2-2-2zm-8 20h2V1h-2v22zm8-6h2v-2h-2v2zM15 5h2V3h-2v2zm4 8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2z"/></svg>
                            </div>
                            <div class="btn-opt" onclick="flipVertical()" style="display:flex;align-items:center;justify-content:center;" title="上下反転">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15 21h2v-2h-2v2zm4-12h2V7h-2v2zM3 5v14c0 1.1.9 2 2 2h4v-2H5V5h4V3H5c-1.1 0-2 .9-2 2zm16-2v2h2c0-1.1-.9-2-2-2zm-8 20h2V1h-2v22zm8-6h2v-2h-2v2zM15 5h2V3h-2v2zm4 8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2z" transform="rotate(90 12 12)"/></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 連続複製セクション -->
            <div class="section" id="sec-duplicate" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-duplicate')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-duplicate')" data-i18n="sec_duplicate">連続複製</span>
                </div>
                <div class="section-content">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #5f6368;" data-i18n="label_count">個数</span>
                        <input type="number" id="duplicateCount" value="3" min="1" max="50" step="1" style="width: 50px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 12px; color: #5f6368;" data-i18n="label_spacing">間隔</span>
                        <input type="number" id="duplicateSpacing" value="20" min="0" step="1" style="width: 50px; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; text-align: right;">
                        <span style="font-size: 11px; color: #5f6368;">px</span>
                    </div>
                    <div class="btn-group" style="margin-top: 0; flex-wrap: wrap; gap: 4px;">
                        <div class="btn-opt" onclick="duplicateHorizontal()" style="display:flex;align-items:center;justify-content:center;" title="右へ複製">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="4" cy="12" r="3"/><circle cx="12" cy="12" r="3"/><circle cx="20" cy="12" r="3"/></svg>
                        </div>
                        <div class="btn-opt" onclick="duplicateVertical()" style="display:flex;align-items:center;justify-content:center;" title="下へ複製">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="4" r="3"/><circle cx="12" cy="12" r="3"/><circle cx="12" cy="20" r="3"/></svg>
                        </div>
                        <div class="btn-opt" onclick="duplicateGrid()" style="display:flex;align-items:center;justify-content:center;" title="グリッド複製">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><circle cx="4" cy="4" r="2.5"/><circle cx="12" cy="4" r="2.5"/><circle cx="20" cy="4" r="2.5"/><circle cx="4" cy="12" r="2.5"/><circle cx="12" cy="12" r="2.5"/><circle cx="20" cy="12" r="2.5"/><circle cx="4" cy="20" r="2.5"/><circle cx="12" cy="20" r="2.5"/><circle cx="20" cy="20" r="2.5"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 順序セクション -->
            <div class="section" id="sec-order" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-order')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-order')" data-i18n="sec_order">順序</span>
                </div>
                <div class="section-content">
                    <div class="btn-group" style="margin-top: 0; flex-wrap: wrap; gap: 4px;">
                        <div class="btn-opt" onclick="bringForward()" style="display:flex;align-items:center;justify-content:center;" title="前面へ移動">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 13h4v4H6v-4zm0-6h4v4H6V7zm6 3h4v4h-4v-4zm6-3h4v4h-4V7z" opacity="0.3"/><path d="M12 5l-4 4h8l-4-4z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="bringToFront()" style="display:flex;align-items:center;justify-content:center;" title="最前面へ移動">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 15h4v4H6v-4zm0-6h4v4H6V9zm6 3h4v4h-4v-4zm6-3h4v4h-4V9z" opacity="0.3"/><path d="M12 3l-4 4h8l-4-4zm-4 6l4-4 4 4H8z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="sendBackward()" style="display:flex;align-items:center;justify-content:center;" title="背面へ移動">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 7h4v4H6V7zm0 6h4v4H6v-4zm6-3h4v4h-4v-4zm6 3h4v4h-4v-4z" opacity="0.3"/><path d="M12 19l4-4H8l4 4z"/></svg>
                        </div>
                        <div class="btn-opt" onclick="sendToBack()" style="display:flex;align-items:center;justify-content:center;" title="最背面へ移動">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v4H6V5zm0 6h4v4H6v-4zm6-3h4v4h-4V8zm6 3h4v4h-4v-4z" opacity="0.3"/><path d="M12 21l4-4H8l4 4zm4-6l-4 4-4-4h8z"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- グループセクション -->
            <div class="section" id="sec-group" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-group')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-group')" data-i18n="sec_group">グループ</span>
                </div>
                <div class="section-content">
                    <div class="group-buttons">
                        <button class="action-btn wide-btn" onclick="groupElements()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm8-2h8v8h-8v-8zm2 2v4h4v-4h-4z" fill="currentColor"/></svg>
                            <span data-i18n="btn_group">グループ化</span>
                        </button>
                        <button class="action-btn wide-btn" onclick="ungroupElements()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm8-2h8v8h-8v-8zm2 2v4h4v-4h-4zM1 1l22 22" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                            <span data-i18n="btn_ungroup">グループ解除</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 共通選択セクション -->
            <div class="section" id="sec-similar" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-similar')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-similar')" data-i18n="sec_similar">共通選択</span>
                </div>
                <div class="section-content">
                    <div class="info-box" data-i18n="info_similar">選択中のオブジェクトと同じ属性を持つオブジェクトを一括選択します</div>
                    <div id="similarAttrs" style="font-size:12px; color:#5f6368; margin-bottom:10px;" data-i18n="label_select_object">オブジェクトを選択してください</div>
                    <div class="similar-buttons" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarFill" onclick="selectSimilar('fillColor')" disabled>
                            <span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:#ccc;vertical-align:middle;margin-right:4px;" id="previewFill"></span><span data-i18n="similar_fill_color">塗りつぶし色</span>
                        </button>
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarStroke" onclick="selectSimilar('strokeColor')" disabled>
                            <span style="display:inline-block;width:12px;height:12px;border:2px solid #ccc;border-radius:2px;vertical-align:middle;margin-right:4px;box-sizing:border-box;" id="previewStroke"></span><span data-i18n="similar_stroke_color">枠線色</span>
                        </button>
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarTextColor" onclick="selectSimilar('textColor')" disabled>
                            <span style="color:#ccc;font-weight:bold;margin-right:4px;" id="previewTextColor">A</span><span data-i18n="similar_text_color">文字色</span>
                        </button>
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarFont" onclick="selectSimilar('fontFamily')" disabled>
                            <span style="font-size:11px;color:#5f6368;margin-right:2px;" id="previewFont">Aa</span><span data-i18n="similar_font">フォント</span>
                        </button>
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarFontSize" onclick="selectSimilar('fontSize')" disabled>
                            <span style="font-size:11px;color:#5f6368;margin-right:2px;" id="previewFontSize">--</span><span data-i18n="similar_font_size">pt</span>
                        </button>
                        <button class="action-btn" style="margin-top:0;" id="btnSimilarStrokeWeight" onclick="selectSimilar('strokeWeight')" disabled>
                            <span style="font-size:11px;color:#5f6368;margin-right:2px;" id="previewStrokeWeight">--</span><span data-i18n="similar_stroke_weight">pt枠</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 書式・スタイルコピー履歴セクション -->
            <div class="section" id="sec-style-history" data-group="utility">
                <div class="section-header">
                    <svg class="drag-handle" viewBox="0 0 24 24" onmousedown="event.stopPropagation()"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    <svg class="arrow-icon" viewBox="0 0 24 24" onclick="toggleSection('sec-style-history')"><path d="M7 10l5 5 5-5z"/></svg>
                    <span class="section-title" onclick="toggleSection('sec-style-history')" data-i18n="sec_style_history">書式履歴</span>
                </div>
                <div class="section-content">
                    <button class="action-btn" onclick="copyCurrentStyle()" style="margin-top:0;">
                        <svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align:middle;margin-right:4px;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/></svg>
                        <span data-i18n="btn_copy_style">選択中のスタイルをコピー</span>
                    </button>
                    <div id="styleHistoryList" style="margin-top:10px;max-height:200px;overflow-y:auto;">
                        <div style="color:#5f6368;font-size:12px;text-align:center;padding:20px 0;" data-i18n="label_no_history">履歴がありません</div>
                    </div>
                    <button class="action-btn" onclick="clearStyleHistory()" style="margin-top:8px;font-size:11px;padding:6px;color:#5f6368;" data-i18n="btn_clear_history">履歴をクリア</button>
                </div>
            </div>

        </div>
        </div>

        <!-- フィードバックボタン -->
        <div style="padding: 12px 16px; border-top: 1px solid #dadce0; background: #fafafa;">
            <button onclick="openFeedback()" style="width: 100%; padding: 10px; background: none; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; color: #5f6368; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM11 5h2v4h-2zm0 6h2v2h-2z"/></svg>
                <span data-i18n="btn_feedback">問題を報告 / フィードバック</span>
            </button>
        </div>

        <!-- トースト通知 -->
        <div id="toast" class="toast"></div>

        <script>
      // ==========================================
      // 国際化 (i18n) システム
      // ==========================================
      const LANG_DATA = {
        ja: {
          // セクションタイトル
          sec_crop: 'トリミング確定',
          sec_extend: 'AI画像拡張',
          sec_upscale: 'AI高画質化',
          sec_color: '色調調整',
          sec_effect: 'エフェクト',
          sec_color_panel: 'カラー',
          sec_stroke: '枠線',
          sec_text: 'テキスト',
          sec_align: '整列',
          sec_shape: '図形',
          sec_duplicate: '連続複製',
          sec_order: '順序',
          sec_group: 'グループ',
          sec_similar: '共通選択',
          sec_style_history: '書式履歴',
          // プレースホルダー
          placeholder_title: '画像を選択してください',
          placeholder_desc: 'スライド上の画像をクリックすると、ここに表示されます。',
          // ボタン
          btn_crop: 'トリミングを実行して確定',
          btn_generate: '生成を実行',
          btn_regenerate: '再生成',
          btn_upscale: '高画質化を実行',
          btn_apply: 'スライドに適用',
          btn_group: 'グループ化',
          btn_ungroup: 'グループ解除',
          btn_copy_style: '選択中のスタイルをコピー',
          btn_clear_history: '履歴をクリア',
          btn_feedback: '問題を報告 / フィードバック',
          btn_horizontal: '水平',
          btn_vertical: '垂直',
          // ラベル
          label_width: '横',
          label_height: '縦',
          label_brightness: '明るさ',
          label_contrast: 'コントラスト',
          label_saturation: '彩度',
          label_hue: '色相',
          label_red: '赤',
          label_green: '緑',
          label_blue: '青',
          label_intensity: '強度',
          label_thickness: '太さ',
          label_type: '種類',
          label_font: 'フォント',
          label_size: 'サイズ',
          label_style: 'スタイル',
          label_line_spacing: '行間',
          label_paragraph: '行間・段落',
          label_before_para: '段落前',
          label_after_para: '段落後',
          label_spacing: '間隔',
          label_even_spacing: '均等間隔配置',
          label_position: '位置',
          label_size_wh: 'サイズ',
          label_rotation: '回転',
          label_flip: '反転',
          label_offset: 'オフセット',
          label_count: '数',
          label_direction: '方向',
          label_recent_colors: '最近使用したカラー',
          label_color_palette: 'カラーパレット',
          label_custom_color: 'カスタムカラー',
          label_no_history: '履歴がありません',
          label_select_object: 'オブジェクトを選択してください',
          label_keep_aspect: '縦横比を維持',
          label_match_size: 'サイズを揃える',
          label_reference: '基準:',
          opt_slide: 'スライド',
          opt_first: '最初に選択した要素',
          opt_last: '最後に選択した要素',
          opt_largest: '最大の要素',
          opt_smallest: '最小の要素',
          tip_match_width: '幅を揃える',
          tip_match_height: '高さを揃える',
          tip_match_both: '両方を揃える',
          label_rotation_flip: '回転・反転',
          label_aspect_ratio: 'アスペクト比に変形',
          // 色ターゲット
          target_fill: '塗り',
          target_stroke: '線',
          target_text: '文字',
          target_highlight: '蛍光ペン',
          // ツールチップ
          tip_reset: 'リセット',
          tip_download: '画像をダウンロード',
          tip_eyedropper: 'スポイト（選択要素から色を取得）',
          tip_none: 'なし',
          tip_white: '白',
          tip_black: '黒',
          tip_solid: '実線',
          tip_dash: '破線',
          tip_dot: '点線',
          tip_dash_dot: '一点鎖線',
          tip_align_left: '左揃え',
          tip_align_center: '中央揃え（横）',
          tip_align_right: '右揃え',
          tip_align_top: '上揃え',
          tip_align_middle: '中央揃え（縦）',
          tip_align_bottom: '下揃え',
          tip_distribute_h: '水平方向に均等配置',
          tip_distribute_v: '垂直方向に均等配置',
          tip_rotate_left: '左に90度回転',
          tip_rotate_right: '右に90度回転',
          tip_flip_h: '左右反転',
          tip_flip_v: '上下反転',
          tip_bring_front: '最前面へ',
          tip_bring_forward: '前面へ',
          tip_send_backward: '背面へ',
          tip_send_back: '最背面へ',
          // エフェクト
          effect_none: 'なし',
          effect_blur: 'ぼかし',
          effect_pixelate: 'モザイク',
          effect_grayscale: 'モノクロ',
          effect_sepia: 'セピア',
          effect_vignette: '周辺減光',
          // 情報ボックス
          info_crop: '現在のトリミング範囲で画像を切り抜き、見えていない部分を削除します。',
          info_extend: 'AIを使用して画像の周囲を描き足します。',
          info_upscale: 'AIを使用して画像の解像度を2倍に高め、ぼやけた輪郭をくっきりと補正します。',
          info_similar: '選択中のオブジェクトと同じ属性を持つオブジェクトを一括選択します',
          // 共通選択ボタン
          similar_fill: '塗り',
          similar_stroke: '線',
          similar_text: '文字',
          similar_font: 'フォント',
          similar_fill_color: '塗りつぶし色',
          similar_stroke_color: '枠線色',
          similar_text_color: '文字色',
          similar_font_size: 'pt',
          similar_stroke_weight: 'pt枠',
          // 複製方向
          dir_right: '右',
          dir_down: '下',
          dir_left: '左',
          dir_up: '上',
          // メッセージ
          msg_loading: '処理中...',
          msg_loading_image: '画像を読み込んでいます...',
          msg_cropping: 'トリミングを実行中...',
          msg_crop_invalid: 'トリミング範囲が無効です',
          msg_enter_extend_size: '拡張サイズを入力してください',
          msg_ai_upscale: 'AI高画質化中(2倍)...',
          msg_ai_generating: 'AI生成中...',
          msg_ai_error: 'AIエラー: ',
          msg_applying: 'スライドに配置中...',
          msg_image_too_large: '画像が大きすぎます',
          msg_image_not_loaded: '画像が読み込まれていません',
          msg_style_copied: 'スタイルをコピーしました',
          msg_history_cleared: '履歴をクリアしました',
          msg_success: '完了しました',
          msg_error: 'エラーが発生しました',
          msg_aligning: '整列中...',
          msg_distributing: '均等配置中...'
        },
        en: {
          // Section titles
          sec_crop: 'Crop',
          sec_extend: 'AI Extend',
          sec_upscale: 'AI Upscale',
          sec_color: 'Color Adjust',
          sec_effect: 'Effects',
          sec_color_panel: 'Color',
          sec_stroke: 'Stroke',
          sec_text: 'Text',
          sec_align: 'Align',
          sec_shape: 'Shape',
          sec_duplicate: 'Duplicate',
          sec_order: 'Order',
          sec_group: 'Group',
          sec_similar: 'Common Select',
          sec_style_history: 'Style History',
          // Placeholder
          placeholder_title: 'Select an image',
          placeholder_desc: 'Click an image on the slide to display it here.',
          // Buttons
          btn_crop: 'Apply Crop',
          btn_generate: 'Generate',
          btn_regenerate: 'Regenerate',
          btn_upscale: 'Upscale',
          btn_apply: 'Apply to Slide',
          btn_group: 'Group',
          btn_ungroup: 'Ungroup',
          btn_copy_style: 'Copy Current Style',
          btn_clear_history: 'Clear History',
          btn_feedback: 'Report Issue / Feedback',
          btn_horizontal: 'Horizontal',
          btn_vertical: 'Vertical',
          // Labels
          label_width: 'Width',
          label_height: 'Height',
          label_brightness: 'Brightness',
          label_contrast: 'Contrast',
          label_saturation: 'Saturation',
          label_hue: 'Hue',
          label_red: 'Red',
          label_green: 'Green',
          label_blue: 'Blue',
          label_intensity: 'Intensity',
          label_thickness: 'Weight',
          label_type: 'Type',
          label_font: 'Font',
          label_size: 'Size',
          label_style: 'Style',
          label_line_spacing: 'Line',
          label_paragraph: 'Line & Paragraph',
          label_before_para: 'Before',
          label_after_para: 'After',
          label_spacing: 'Spacing',
          label_even_spacing: 'Even Spacing',
          label_position: 'Position',
          label_size_wh: 'Size',
          label_rotation: 'Rotation',
          label_flip: 'Flip',
          label_offset: 'Offset',
          label_count: 'Count',
          label_direction: 'Direction',
          label_recent_colors: 'Recent Colors',
          label_color_palette: 'Color Palette',
          label_custom_color: 'Custom Color',
          label_no_history: 'No history',
          label_select_object: 'Select an object',
          label_keep_aspect: 'Keep aspect ratio',
          label_match_size: 'Match Size',
          label_reference: 'Reference:',
          opt_slide: 'Slide',
          opt_first: 'First selected',
          opt_last: 'Last selected',
          opt_largest: 'Largest element',
          opt_smallest: 'Smallest element',
          tip_match_width: 'Match width',
          tip_match_height: 'Match height',
          tip_match_both: 'Match both',
          label_rotation_flip: 'Rotate & Flip',
          label_aspect_ratio: 'Transform Aspect Ratio',
          // Color targets
          target_fill: 'Fill',
          target_stroke: 'Stroke',
          target_text: 'Text',
          target_highlight: 'Highlight',
          // Tooltips
          tip_reset: 'Reset',
          tip_download: 'Download Image',
          tip_eyedropper: 'Eyedropper (pick color from element)',
          tip_none: 'None',
          tip_white: 'White',
          tip_black: 'Black',
          tip_solid: 'Solid',
          tip_dash: 'Dashed',
          tip_dot: 'Dotted',
          tip_dash_dot: 'Dash-dot',
          tip_align_left: 'Align Left',
          tip_align_center: 'Center (H)',
          tip_align_right: 'Align Right',
          tip_align_top: 'Align Top',
          tip_align_middle: 'Center (V)',
          tip_align_bottom: 'Align Bottom',
          tip_distribute_h: 'Distribute Horizontally',
          tip_distribute_v: 'Distribute Vertically',
          tip_rotate_left: 'Rotate Left 90°',
          tip_rotate_right: 'Rotate Right 90°',
          tip_flip_h: 'Flip Horizontal',
          tip_flip_v: 'Flip Vertical',
          tip_bring_front: 'Bring to Front',
          tip_bring_forward: 'Bring Forward',
          tip_send_backward: 'Send Backward',
          tip_send_back: 'Send to Back',
          // Effects
          effect_none: 'None',
          effect_blur: 'Blur',
          effect_pixelate: 'Pixelate',
          effect_grayscale: 'Grayscale',
          effect_sepia: 'Sepia',
          effect_vignette: 'Vignette',
          // Info boxes
          info_crop: 'Crop the image to the current trim area and remove hidden parts.',
          info_extend: 'Use AI to extend the image boundaries.',
          info_upscale: 'Use AI to double the resolution and sharpen blurry edges.',
          info_similar: 'Select all objects with the same attributes as the selected object.',
          // Similar select buttons
          similar_fill: 'Fill',
          similar_stroke: 'Stroke',
          similar_text: 'Text',
          similar_font: 'Font',
          similar_fill_color: 'Fill Color',
          similar_stroke_color: 'Stroke Color',
          similar_text_color: 'Text Color',
          similar_font_size: 'pt',
          similar_stroke_weight: 'pt stroke',
          // Duplicate directions
          dir_right: 'Right',
          dir_down: 'Down',
          dir_left: 'Left',
          dir_up: 'Up',
          // Messages
          msg_loading: 'Processing...',
          msg_loading_image: 'Loading image...',
          msg_cropping: 'Cropping...',
          msg_crop_invalid: 'Invalid crop area',
          msg_enter_extend_size: 'Please enter extend size',
          msg_ai_upscale: 'AI Upscaling (2x)...',
          msg_ai_generating: 'AI Generating...',
          msg_ai_error: 'AI Error: ',
          msg_applying: 'Applying to slide...',
          msg_image_too_large: 'Image is too large',
          msg_image_not_loaded: 'Image not loaded',
          msg_style_copied: 'Style copied',
          msg_history_cleared: 'History cleared',
          msg_success: 'Complete',
          msg_error: 'An error occurred',
          msg_aligning: 'Aligning...',
          msg_distributing: 'Distributing...'
        }
      };

      // 現在の言語（URLパラメータまたはlocalStorageから取得）
      let currentLang = 'ja';
      (function() {
        var params = new URLSearchParams(window.location.search);
        var langParam = params.get('lang');
        if (langParam && LANG_DATA[langParam]) {
          currentLang = langParam;
        } else {
          var saved = localStorage.getItem('dp_lang');
          if (saved && LANG_DATA[saved]) {
            currentLang = saved;
          }
        }
        localStorage.setItem('dp_lang', currentLang);
      })();

      // 翻訳関数
      function t(key) {
        return LANG_DATA[currentLang][key] || LANG_DATA['ja'][key] || key;
      }

      // ページ内のテキストを翻訳
      function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(function(el) {
          var key = el.getAttribute('data-i18n');
          // option要素の場合はtextContentではなくinnerTextを使用
          if (el.tagName === 'OPTION') {
            el.text = t(key);
          } else {
            el.textContent = t(key);
          }
        });
        document.querySelectorAll('[data-i18n-title]').forEach(function(el) {
          var key = el.getAttribute('data-i18n-title');
          el.setAttribute('title', t(key));
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
          var key = el.getAttribute('data-i18n-placeholder');
          el.setAttribute('placeholder', t(key));
        });
        document.querySelectorAll('[data-i18n-label]').forEach(function(el) {
          var key = el.getAttribute('data-i18n-label');
          el.setAttribute('data-label', t(key));
        });
      }

      // ==========================================
      // ✅ 設定済みURL
      // ==========================================
      const CLOUD_FUNCTION_URL = "https://generate-image-1017901325674.us-central1.run.app";
      // ==========================================

      // トースト通知
      function showToast(message, type, duration) {
        type = type || 'info';
        duration = duration || 3000;
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type;
        toast.classList.add('show');
        setTimeout(function() {
          toast.classList.remove('show');
        }, duration);
      }

      var canvas = document.getElementById('previewCanvas');
      var ctx = canvas.getContext('2d');
      var originalImg = new Image();
      var isImageLoaded = false;
      var aiResultImg = null;
      var currentCropInfo = null;
      var currentImageId = null;

      var state = { extW: 0, extH: 0, upscaleFactor: '2x', brightness: 100, contrast: 100, saturate: 100, hue: 0, colorR: 0, colorG: 0, colorB: 0, effectType: 'none', effectVal: 0 };

      // --- Auto Poll (500ms Interval) ---
      var pollingEnabled = true;
      window.onload = function() {
        if (pollingEnabled) {
          setInterval(checkAndFetch, 500);
        }
      };

      var lastElementId = null;
      function checkAndFetch() {
        // 全要素の選択変更を監視（色情報用）
        google.script.run.withSuccessHandler(function(id) {
            // 選択要素が変わったら色情報を取得
            if (id !== lastElementId) {
              lastElementId = id;
              loadSelectedElementColors();
              loadSelectedElementSizeAndPosition();
              updateSimilarPanel(); // 類似オブジェクト選択パネルも更新
            }
        }).withFailureHandler(function(e) {
            console.log("Polling error: " + e.message);
        }).checkSelection();

        // 画像の選択変更を監視（画像編集用）
        google.script.run.withSuccessHandler(function(imageId) {
            if (imageId !== currentImageId) {
               if (imageId) {
                 currentImageId = imageId;
                 fetchImage();
               } else {
                 currentImageId = null;
                 resetToPlaceholder();
               }
            }
        }).withFailureHandler(function(e) {
            console.log("Image polling error: " + e.message);
        }).checkSelectionForImage();
      }

      function loadSelectedElementSizeAndPosition() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result) {
              document.getElementById('positionX').value = result.x;
              document.getElementById('positionY').value = result.y;
              document.getElementById('sizeWidth').value = result.width;
              document.getElementById('sizeHeight').value = result.height;
            }
          })
          .withFailureHandler(function(e) {
            console.log('Error getting size/position:', e.message);
          })
          .getSelectedElementSizeAndPosition();
      }

      function loadSelectedElementColors() {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('getSelectedElementColors result:', JSON.stringify(result));
            if (result) {
              // 塗りつぶしの透明度（先に処理）
              if (result.fillAlpha !== undefined) {
                colorState.alpha = Math.round(result.fillAlpha * 100);
                document.getElementById('sliderA').value = colorState.alpha;
                document.getElementById('valueA').value = colorState.alpha;
              }
              // 塗りつぶし色
              if (result.fillColor) {
                colorState.fillColor = result.fillColor;
                document.getElementById('fillBox').classList.remove('none');
                document.getElementById('fillPreview').style.background = hexToRgba(result.fillColor, colorState.alpha / 100);
              } else {
                colorState.fillColor = null;
                document.getElementById('fillBox').classList.add('none');
              }
              // 枠線色
              if (result.strokeColor) {
                colorState.strokeColor = result.strokeColor;
                document.getElementById('strokeBox').classList.remove('none');
                document.getElementById('strokePreview').style.borderColor = result.strokeColor;
              } else {
                colorState.strokeColor = null;
                document.getElementById('strokeBox').classList.add('none');
              }
              // 枠線スタイル
              if (result.strokeWeight !== null) {
                colorState.strokeWeight = result.strokeWeight;
                document.getElementById('strokeWeight').value = result.strokeWeight;
              }
              if (result.strokeDashStyle) {
                colorState.strokeDashStyle = result.strokeDashStyle;
                // ダッシュスタイルのUI更新
                var dashOptions = document.querySelectorAll('.dash-option');
                dashOptions.forEach(function(opt) {
                  opt.classList.remove('selected');
                  if (opt.getAttribute('data-dash') === result.strokeDashStyle) {
                    opt.classList.add('selected');
                  }
                });
              }
              // テキスト色
              if (result.textColor) {
                colorState.textColor = result.textColor;
                document.getElementById('textColorBar').style.background = result.textColor;
              }
              // ハイライト色
              if (result.backgroundColor) {
                colorState.highlightColor = result.backgroundColor;
                document.getElementById('highlightTarget').classList.remove('none');
                document.getElementById('highlightBg').style.background = result.backgroundColor;
              } else {
                colorState.highlightColor = null;
                document.getElementById('highlightTarget').classList.add('none');
              }
              // フォント情報
              if (result.fontSize !== null && result.fontSize !== undefined) {
                document.getElementById('fontSizeInput').value = result.fontSize;
              }
              if (result.fontFamily) {
                document.getElementById('fontSelect').value = result.fontFamily;
              }
              if (result.bold !== null && result.bold !== undefined) {
                document.getElementById('btnBold').classList.toggle('active', result.bold === true);
              } else {
                document.getElementById('btnBold').classList.remove('active');
              }
              if (result.italic !== null && result.italic !== undefined) {
                document.getElementById('btnItalic').classList.toggle('active', result.italic === true);
              } else {
                document.getElementById('btnItalic').classList.remove('active');
              }
              if (result.underline !== null && result.underline !== undefined) {
                document.getElementById('btnUnderline').classList.toggle('active', result.underline === true);
              } else {
                document.getElementById('btnUnderline').classList.remove('active');
              }
              if (result.strikethrough !== null && result.strikethrough !== undefined) {
                document.getElementById('btnStrikethrough').classList.toggle('active', result.strikethrough === true);
              } else {
                document.getElementById('btnStrikethrough').classList.remove('active');
              }
              // 行間・段落間隔
              if (result.lineSpacing !== null && result.lineSpacing !== undefined) {
                document.getElementById('lineSpacing').value = result.lineSpacing;
              }
              if (result.spaceBefore !== null && result.spaceBefore !== undefined) {
                document.getElementById('spaceBefore').value = result.spaceBefore;
              }
              if (result.spaceAfter !== null && result.spaceAfter !== undefined) {
                document.getElementById('spaceAfter').value = result.spaceAfter;
              }
              // 現在選択中のターゲットに応じてカラーパネルを更新
              updateColorPanelFromState();
            }
          })
          .withFailureHandler(function(e) {
            // 選択なしの場合は無視
          })
          .getSelectedElementColors(currentLang);
      }

      function updateColorPanelFromState() {
        var color = null;
        if (colorState.activeTarget === 'fill') {
          color = colorState.fillColor;
        } else if (colorState.activeTarget === 'stroke') {
          color = colorState.strokeColor;
        } else if (colorState.activeTarget === 'text') {
          color = colorState.textColor;
        } else if (colorState.activeTarget === 'highlight') {
          color = colorState.highlightColor;
        }
        console.log('updateColorPanelFromState: activeTarget=' + colorState.activeTarget + ', color=' + color);
        if (color) {
          // 色が正しい形式か確認し、#で始まっていなければ追加
          if (color.charAt(0) !== '#') {
            color = '#' + color;
          }
          setColorToUI(color);
        }
      }

      function fetchImage() {
        showLoadingOverlay(t('msg_loading_image'));
        document.getElementById('errorMessage').style.display = 'none';
        google.script.run.withSuccessHandler(onImageLoaded).withFailureHandler(onError).getSelectedImage(currentLang);
      }

      function onImageLoaded(data) {
        currentCropInfo = data.cropInfo;
        var cropBtn = document.getElementById('cropBtn');
        if (currentCropInfo && ((currentCropInfo.leftOffset > 0) || (currentCropInfo.rightOffset > 0) || (currentCropInfo.topOffset > 0) || (currentCropInfo.bottomOffset > 0))) {
          cropBtn.disabled = false;
        } else {
          cropBtn.disabled = true;
        }
        loadBase64(data.base64);
      }

      function loadBase64(base64Data) {
        originalImg.onload = function() {
          isImageLoaded = true; aiResultImg = null;
          document.getElementById('rangeW').value = 0; document.getElementById('numW').value = 0;
          document.getElementById('rangeH').value = 0; document.getElementById('numH').value = 0;
          resetAllParams();
          updateStateFromUI(); updatePreview();
          hideLoadingOverlay();
          document.getElementById('placeholder').style.display = 'none';
          document.getElementById('previewCanvas').style.display = 'block';
          // ボタンを有効化
          document.getElementById('applyBtn').disabled = false;
          document.getElementById('generateBtn').disabled = false;
          document.getElementById('generateBtn').style.display = 'block';
          document.getElementById('upscaleBtn').disabled = false;
          document.getElementById('postGenButtons').style.display = 'none';
          document.getElementById('downloadBtn').classList.add('active');
        };
        originalImg.src = base64Data;
      }

      function onError(e) {
        console.log("Load error: " + e.message);
        resetToPlaceholder(e.message);
      }

      function resetToPlaceholder(errorMsg) {
        isImageLoaded = false;
        aiResultImg = null;
        document.getElementById('placeholder').style.display = 'flex';
        document.getElementById('previewCanvas').style.display = 'none';
        // ボタンを無効化
        document.getElementById('applyBtn').disabled = true;
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('upscaleBtn').disabled = true;
        document.getElementById('cropBtn').disabled = true;
        document.getElementById('downloadBtn').classList.remove('active');
        hideLoadingOverlay();

        if (errorMsg) {
          var errMsgDiv = document.getElementById('errorMessage');
          errMsgDiv.textContent = errorMsg.includes("選択") ? "" : "エラー: " + errorMsg;
          errMsgDiv.style.display = errorMsg.includes("選択") ? 'none' : 'block';
        } else {
          document.getElementById('errorMessage').style.display = 'none';
        }
      }

      function showLoadingOverlay(msg) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingText').textContent = msg;
      }
      function hideLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
      function resetAndLoad() { currentImageId = null; checkAndFetch(); }

      function syncVal(key) { var val = document.getElementById(key + 'Range').value; state[key] = parseInt(val); document.getElementById('val_' + key).value = val; updatePreview(); }
      function syncColor(key) { syncVal(key); }
      function syncColorFromInput(key) { var val = parseInt(document.getElementById('val_' + key).value) || 0; state[key] = val; document.getElementById(key + 'Range').value = val; updatePreview(); }
      function resetVal(key, def) { state[key] = def; document.getElementById(key + 'Range').value = def; document.getElementById('val_' + key).value = def; updatePreview(); }
      function resetAllParams() { ['brightness','contrast','saturate'].forEach(k => resetVal(k, 100)); ['hue','colorR','colorG','colorB'].forEach(k => resetVal(k, 0)); setEffect('none', document.querySelector('.btn-opt')); document.getElementById('effectRange').value = 0; }
      function updateStateFromUI() { state.extW = parseInt(document.getElementById('rangeW').value); state.extH = parseInt(document.getElementById('rangeH').value); }
      function syncSlider(axis, val) { document.getElementById('range' + axis.toUpperCase()).value = val; updateStateFromUI(); updatePreview(); }
      function syncNum(axis, val) { document.getElementById('num' + axis.toUpperCase()).value = val; updateStateFromUI(); updatePreview(); }
      function toggleSection(id) {
        var section = document.getElementById(id);
        section.classList.toggle('open');
        // カラーパネルを開いた時にスペクトラムを再描画
        if (id === 'sec-color-panel' && section.classList.contains('open')) {
          setTimeout(function() {
            initSpectrum();
          }, 50);
        }
        // 状態を保存
        saveSectionStates();
      }

      // セクションの開閉状態を保存
      function saveSectionStates() {
        var sections = document.querySelectorAll('.section');
        var states = {};
        sections.forEach(function(section) {
          if (section.id) {
            states[section.id] = section.classList.contains('open');
          }
        });
        try {
          localStorage.setItem('sidebarSectionStates', JSON.stringify(states));
        } catch(e) {}
      }

      // セクションの開閉状態を復元
      function restoreSectionStates() {
        try {
          var saved = localStorage.getItem('sidebarSectionStates');
          if (saved) {
            var states = JSON.parse(saved);
            for (var id in states) {
              var section = document.getElementById(id);
              if (section) {
                if (states[id]) {
                  section.classList.add('open');
                  // カラーパネルを開く場合はスペクトラムを初期化
                  if (id === 'sec-color-panel') {
                    setTimeout(function() {
                      initSpectrum();
                    }, 50);
                  }
                } else {
                  section.classList.remove('open');
                }
              }
            }
          }
        } catch(e) {}
      }
      function setEffect(type, el) { state.effectType = type; document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('selected')); if(el) el.classList.add('selected'); var slider = document.getElementById('effectRange'); if (type === 'none') { state.effectVal = 0; slider.value = 0; slider.disabled = true; } else { if (state.effectVal === 0) { state.effectVal = (type === 'vignette' || type === 'grayscale' || type === 'sepia') ? 50 : 20; slider.value = state.effectVal; } slider.disabled = false; } document.getElementById('effectValLabel').textContent = slider.value; updatePreview(); }

      function updatePreview() {
        if (!isImageLoaded && !aiResultImg) return;
        var baseImg = aiResultImg ? aiResultImg : originalImg;
        var tempCanvas = document.createElement('canvas'); var tCtx = tempCanvas.getContext('2d');
        if (!aiResultImg && (state.extW > 0 || state.extH > 0)) {
          var addW = originalImg.width * (state.extW / 100) * 2; var addH = originalImg.height * (state.extH / 100) * 2;
          tempCanvas.width = originalImg.width + addW; tempCanvas.height = originalImg.height + addH;
          tCtx.fillStyle = '#ffffff'; tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
          tCtx.drawImage(originalImg, addW/2, addH/2);
        } else {
          tempCanvas.width = baseImg.width; tempCanvas.height = baseImg.height; tCtx.drawImage(baseImg, 0, 0);
        }
        applyAllEffects(tempCanvas); drawFinal(tempCanvas);
      }

      function applyAllEffects(tgtCanvas) {
        var ctx = tgtCanvas.getContext('2d'); var w = tgtCanvas.width; var h = tgtCanvas.height;
        document.getElementById('effectValLabel').textContent = document.getElementById('effectRange').value;
        state.effectVal = parseInt(document.getElementById('effectRange').value);
        if (state.colorR !== 0 || state.colorG !== 0 || state.colorB !== 0) {
          var imageData = ctx.getImageData(0, 0, w, h); var data = imageData.data;
          var r = state.colorR, g = state.colorG, b = state.colorB;
          for (var i = 0; i < data.length; i += 4) { data[i] = Math.min(255, Math.max(0, data[i] + r)); data[i+1] = Math.min(255, Math.max(0, data[i+1] + g)); data[i+2] = Math.min(255, Math.max(0, data[i+2] + b)); }
          ctx.putImageData(imageData, 0, 0);
        }
        if (state.effectType === 'pixelate' && state.effectVal > 0) {
          var rate = 1 - (state.effectVal * 0.009); if (rate < 0.02) rate = 0.02; var sw = w * rate; var sh = h * rate;
          ctx.imageSmoothingEnabled = false; var sm = document.createElement('canvas'); sm.width = sw; sm.height = sh;
          sm.getContext('2d').drawImage(tgtCanvas, 0, 0, sw, sh); ctx.clearRect(0,0,w,h); ctx.drawImage(sm, 0, 0, sw, sh, 0, 0, w, h);
        }
        var filters = [];
        if (state.effectType === 'blur' && state.effectVal > 0) filters.push(`blur(${state.effectVal/2}px)`);
        if (state.effectType === 'grayscale') filters.push(`grayscale(${state.effectVal}%)`);
        if (state.effectType === 'sepia') filters.push(`sepia(${state.effectVal}%)`);
        if (state.brightness != 100) filters.push(`brightness(${state.brightness}%)`);
        if (state.contrast != 100) filters.push(`contrast(${state.contrast}%)`);
        if (state.saturate != 100) filters.push(`saturate(${state.saturate}%)`);
        if (state.hue != 0) filters.push(`hue-rotate(${state.hue}deg)`);
        if (filters.length > 0) {
          var copy = document.createElement('canvas'); copy.width = w; copy.height = h; copy.getContext('2d').drawImage(tgtCanvas, 0, 0);
          ctx.save(); ctx.filter = filters.join(' '); ctx.clearRect(0, 0, w, h); ctx.drawImage(copy, 0, 0); ctx.restore();
        }
        if (state.effectType === 'vignette' && state.effectVal > 0) {
           var cx = w / 2; var cy = h / 2; var maxR = Math.sqrt(Math.pow(cx, 2) + Math.pow(cy, 2));
           var grd = ctx.createRadialGradient(cx, cy, w * 0.2, cx, cy, maxR);
           grd.addColorStop(0, "rgba(0,0,0,0)"); var darkness = (state.effectVal / 100) * 0.9; grd.addColorStop(1, "rgba(0,0,0," + darkness + ")");
           ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h);
        }
      }
      function drawFinal(srcCanvas) { canvas.width = srcCanvas.width; canvas.height = srcCanvas.height; var ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(srcCanvas, 0, 0); }
      function performCrop() {
        if (!isImageLoaded || !currentCropInfo) return; showLoadingOverlay(t('msg_cropping'));
        var w = originalImg.width; var h = originalImg.height;
        var left = w * (currentCropInfo.leftOffset || 0); var top = h * (currentCropInfo.topOffset || 0);
        var right = w * (currentCropInfo.rightOffset || 0); var bottom = h * (currentCropInfo.bottomOffset || 0);
        var cropW = w - left - right; var cropH = h - top - bottom;
        if (cropW <= 0 || cropH <= 0) { hideLoadingOverlay(); showToast(t('msg_crop_invalid'), "error"); return; }
        var cropCanvas = document.createElement('canvas'); cropCanvas.width = cropW; cropCanvas.height = cropH; var cCtx = cropCanvas.getContext('2d'); cCtx.drawImage(originalImg, left, top, cropW, cropH, 0, 0, cropW, cropH);
        var newBase64 = cropCanvas.toDataURL('image/png'); currentCropInfo = null; document.getElementById('cropBtn').disabled = true; loadBase64(newBase64);
      }
      function callCloudAI(mode) {
        if (mode === 'extend' && state.extW === 0 && state.extH === 0) { showToast(t('msg_enter_extend_size'), "error"); return; }
        showLoadingOverlay(mode === 'upscale' ? t('msg_ai_upscale') : t('msg_ai_generating'));
        var rawBase64 = (aiResultImg && mode === 'upscale') ? aiResultImg.src : originalImg.src;
        fetch(CLOUD_FUNCTION_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: mode, image: rawBase64, expand_w: state.extW, expand_h: state.extH, prompt: "", upscale_factor: '2x' })
        }).then(res => res.json()).then(data => {
          if (data.error) throw new Error(data.error);
          var newImg = new Image(); newImg.onload = function() {
            aiResultImg = newImg;
            if(mode === 'extend') { document.getElementById('generateBtn').style.display = 'none'; document.getElementById('postGenButtons').style.display = 'flex'; }
            updatePreview(); hideLoadingOverlay();
          }; newImg.src = data.result_image;
        }).catch(err => { console.error(err); showToast(t('msg_ai_error') + err.message, "error"); hideLoadingOverlay(); });
      }
      function applyToSlide() {
        showLoadingOverlay(t('msg_applying'));
        var maxDim = 3840; var w = canvas.width; var h = canvas.height; var scale = Math.min(1, Math.min(maxDim / w, maxDim / h));
        var outputCanvas = document.createElement('canvas'); outputCanvas.width = w * scale; outputCanvas.height = h * scale; var oCtx = outputCanvas.getContext('2d'); oCtx.imageSmoothingEnabled = true; oCtx.imageSmoothingQuality = 'high';
        oCtx.drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);
        var data = outputCanvas.toDataURL('image/jpeg', 0.85);
        google.script.run.withSuccessHandler(() => { hideLoadingOverlay(); }).withFailureHandler((e) => {
             console.log("Retry with lower quality..."); var lowData = outputCanvas.toDataURL('image/jpeg', 0.7);
             google.script.run.withSuccessHandler(() => { hideLoadingOverlay(); }).withFailureHandler((e2) => { showToast(t('msg_image_too_large'), "error"); hideLoadingOverlay(); }).replaceImage(lowData, currentLang);
        }).replaceImage(data, currentLang);
      }

      function downloadImage() {
        if (!isImageLoaded && !aiResultImg) {
          showToast(t('msg_image_not_loaded'), 'error');
          return;
        }

        // 現在のcanvasの内容をダウンロード
        var dataURL = canvas.toDataURL('image/png');

        // ダウンロード用のリンクを作成
        var link = document.createElement('a');
        var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        link.download = 'slide-ai-tool_' + timestamp + '.png';
        link.href = dataURL;

        // クリックしてダウンロード
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ==========================================
      // 整列機能
      // ==========================================
      function alignElement(type) {
        var statusEl = document.getElementById('alignStatus');
        statusEl.textContent = t('msg_aligning');
        statusEl.style.color = '#1a73e8';

        // 選択された基準タイプを取得
        var referenceType = document.getElementById('alignReferenceType').value;

        google.script.run
          .withSuccessHandler(function(result) {
            statusEl.textContent = '✓ ' + result;
            statusEl.style.color = '#188038';
            setTimeout(function() {
              statusEl.textContent = '';
            }, 2000);
          })
          .withFailureHandler(function(error) {
            statusEl.textContent = '✗ ' + error.message;
            statusEl.style.color = '#d93025';
            setTimeout(function() {
              statusEl.textContent = '';
            }, 3000);
          })
          .alignElements(type, referenceType, currentLang);
      }

      // ==========================================
      // 均等配置機能
      // ==========================================
      function distributeElement(direction) {
        var statusEl = document.getElementById('alignStatus');
        statusEl.textContent = t('msg_distributing');
        statusEl.style.color = '#1a73e8';

        var functionName = '';
        switch(direction) {
          case 'horizontal':
            functionName = 'distributeHorizontally';
            break;
          case 'vertical':
            functionName = 'distributeVertically';
            break;
          default:
            statusEl.textContent = currentLang === 'en' ? 'Unknown type' : '不明な配置タイプ';
            statusEl.style.color = '#d93025';
            return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            statusEl.textContent = '✓ ' + result;
            statusEl.style.color = '#188038';
            setTimeout(function() {
              statusEl.textContent = '';
            }, 2000);
          })
          .withFailureHandler(function(error) {
            statusEl.textContent = '✗ ' + error.message;
            statusEl.style.color = '#d93025';
            setTimeout(function() {
              statusEl.textContent = '';
            }, 3000);
          })
          [functionName](currentLang);
      }

      // ==========================================
      // カラーパネル機能
      // ==========================================
      var colorState = {
        activeTarget: 'fill',
        fillColor: '#1A73E8',
        strokeColor: null,
        textColor: '#000000',
        highlightColor: null,
        strokeWeight: 1,
        strokeDashStyle: 'SOLID',
        currentHue: 220,
        recentColors: [],
        alpha: 100
      };

      var swatchColors = [
        '#000000', '#434343', '#666666', '#999999', '#B7B7B7', '#CCCCCC', '#D9D9D9', '#EFEFEF', '#F3F3F3', '#FFFFFF',
        '#FF0000', '#FF9900', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF', '#9900FF', '#FF00FF', '#FF6699', '#FFB3BA',
        '#D93025', '#F29900', '#FBBC04', '#34A853', '#4285F4', '#1A73E8', '#A142F4', '#E91E63', '#FF5722', '#795548',
        '#F4CCCC', '#FCE5CD', '#FFF2CC', '#D9EAD3', '#D0E0E3', '#CFE2F3', '#D9D2E9', '#EAD1DC', '#FFCCBC', '#D7CCC8',
        '#990000', '#B45F06', '#BF9000', '#38761D', '#134F5C', '#0B5394', '#351C75', '#741B47', '#BF360C', '#4E342E'
      ];

      var spectrumCanvas, spectrumCtx;
      var isDraggingSpectrum = false;

      // カラーパネル初期化（window.onloadを拡張）
      var originalOnLoad = window.onload;
      window.onload = function() {
        if (originalOnLoad) originalOnLoad();
        restoreSectionStates();
        initColorPanel();
        loadStyleHistory();
        applyTranslations(); // i18n
        // 初期読み込み: サイドバーを開いた時点で選択中の要素の色を取得（少し遅延）
        setTimeout(function() {
          loadSelectedElementColors();
          loadSelectedElementSizeAndPosition();
        }, 300);
      };

      function initColorPanel() {
        initSwatches();
        initSpectrum();
        loadRecentColors();
      }

      function setActiveTarget(target) {
        colorState.activeTarget = target;
        document.getElementById('fillBox').classList.toggle('active', target === 'fill');
        document.getElementById('strokeBox').classList.toggle('active', target === 'stroke');
        document.getElementById('textColorTarget').classList.toggle('active', target === 'text');
        document.getElementById('highlightTarget').classList.toggle('active', target === 'highlight');

        var currentColor;
        if (target === 'fill') currentColor = colorState.fillColor;
        else if (target === 'stroke') currentColor = colorState.strokeColor;
        else if (target === 'text') currentColor = colorState.textColor;
        else currentColor = colorState.highlightColor;
        if (currentColor) setColorToUI(currentColor);

        // テキスト・ハイライトの場合はAlphaスライダーを無効化
        var alphaEnabled = (target === 'fill' || target === 'stroke');
        var sliderA = document.getElementById('sliderA');
        var valueA = document.getElementById('valueA');
        sliderA.disabled = !alphaEnabled;
        valueA.disabled = !alphaEnabled;
        var alphaRow = sliderA.parentElement;
        alphaRow.style.opacity = alphaEnabled ? '1' : '0.4';
      }

      function setNone() {
        if (colorState.activeTarget === 'fill') {
          colorState.fillColor = null;
          document.getElementById('fillBox').classList.add('none');
          document.getElementById('fillPreview').style.background = '';
          google.script.run.setFillColor(null, 1, currentLang);
        } else if (colorState.activeTarget === 'stroke') {
          colorState.strokeColor = null;
          document.getElementById('strokeBox').classList.add('none');
          document.getElementById('strokePreview').style.borderColor = '';
          google.script.run.setStrokeColor(null, 1, currentLang);
        } else if (colorState.activeTarget === 'highlight') {
          colorState.highlightColor = null;
          document.getElementById('highlightTarget').classList.add('none');
          document.getElementById('highlightBg').style.background = '';
          google.script.run.setTextBackgroundColor(null, currentLang);
        }
      }

      function setQuickColor(color) {
        setColor(color, true);
      }

      function setColor(hexColor, addToRecent) {
        var funcName;
        var useAlpha = false;
        if (colorState.activeTarget === 'fill') {
          colorState.fillColor = hexColor;
          document.getElementById('fillBox').classList.remove('none');
          document.getElementById('fillPreview').style.background = hexToRgba(hexColor, colorState.alpha / 100);
          funcName = 'setFillColor';
          useAlpha = true;
        } else if (colorState.activeTarget === 'stroke') {
          colorState.strokeColor = hexColor;
          document.getElementById('strokeBox').classList.remove('none');
          document.getElementById('strokePreview').style.borderColor = hexColor;
          funcName = 'setStrokeColor';
          useAlpha = true;
        } else if (colorState.activeTarget === 'text') {
          colorState.textColor = hexColor;
          document.getElementById('textColorBar').style.background = hexColor;
          funcName = 'setTextColor';
        } else if (colorState.activeTarget === 'highlight') {
          colorState.highlightColor = hexColor;
          document.getElementById('highlightTarget').classList.remove('none');
          document.getElementById('highlightBg').style.background = hexColor;
          funcName = 'setTextBackgroundColor';
        }
        setColorToUI(hexColor);
        if (addToRecent) addToRecentColors(hexColor);
        // 自動的にスライドに適用（alphaは0-100を0-1に変換）
        if (funcName) {
          if (useAlpha) {
            var alpha = colorState.alpha / 100;
            google.script.run[funcName](hexColor, alpha, currentLang);
          } else {
            google.script.run[funcName](hexColor, currentLang);
          }
        }
      }

      function setColorToUI(hexColor) {
        var rgb = hexToRgb(hexColor);
        document.getElementById('sliderR').value = rgb.r;
        document.getElementById('sliderG').value = rgb.g;
        document.getElementById('sliderB').value = rgb.b;
        document.getElementById('valueR').value = rgb.r;
        document.getElementById('valueG').value = rgb.g;
        document.getElementById('valueB').value = rgb.b;
        document.getElementById('hexInput').value = hexColor.replace('#', '');
        document.getElementById('hexPreview').style.backgroundColor = hexColor;
        var hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
        colorState.currentHue = hsv.h;
        document.getElementById('hueSlider').value = hsv.h;
        drawSpectrum(hsv.h);
        updateSpectrumCursor(hsv.s, hsv.v);
      }

      function initSwatches() {
        var grid = document.getElementById('swatchGrid');
        if (!grid) return;
        swatchColors.forEach(function(color) {
          var swatch = document.createElement('div');
          swatch.className = 'swatch';
          swatch.style.backgroundColor = color;
          swatch.onclick = function() { setColor(color, true); };
          grid.appendChild(swatch);
        });
      }

      function loadRecentColors() {
        try {
          var saved = localStorage.getItem('recentColors');
          if (saved) colorState.recentColors = JSON.parse(saved);
        } catch(e) {}
        renderRecentColors();
      }

      function addToRecentColors(color) {
        colorState.recentColors = colorState.recentColors.filter(function(c) {
          return c.toUpperCase() !== color.toUpperCase();
        });
        colorState.recentColors.unshift(color);
        if (colorState.recentColors.length > 8) colorState.recentColors = colorState.recentColors.slice(0, 8);
        try { localStorage.setItem('recentColors', JSON.stringify(colorState.recentColors)); } catch(e) {}
        renderRecentColors();
      }

      function renderRecentColors() {
        var container = document.getElementById('recentColors');
        if (!container) return;
        container.innerHTML = '';
        for (var i = 0; i < 8; i++) {
          var div = document.createElement('div');
          div.className = 'recent-color';
          if (colorState.recentColors[i]) {
            div.style.backgroundColor = colorState.recentColors[i];
            div.onclick = (function(color) { return function() { setColor(color, false); }; })(colorState.recentColors[i]);
          } else {
            div.className += ' empty';
          }
          container.appendChild(div);
        }
      }

      function initSpectrum() {
        spectrumCanvas = document.getElementById('colorSpectrum');
        if (!spectrumCanvas) return;
        spectrumCtx = spectrumCanvas.getContext('2d');
        // コンテナの幅を取得、取得できない場合はデフォルト値
        var containerWidth = spectrumCanvas.parentElement ? spectrumCanvas.parentElement.offsetWidth : 0;
        var width = containerWidth > 0 ? containerWidth : 276;
        var height = 120;
        spectrumCanvas.width = width;
        spectrumCanvas.height = height;
        drawSpectrum(colorState.currentHue);
        // イベントリスナーは一度だけ追加
        if (!spectrumCanvas.hasListener) {
          spectrumCanvas.hasListener = true;
          spectrumCanvas.addEventListener('mousedown', function(e) { isDraggingSpectrum = true; pickColorFromSpectrum(e); });
          document.addEventListener('mousemove', function(e) { if (isDraggingSpectrum) pickColorFromSpectrum(e); });
          document.addEventListener('mouseup', function() {
            if (isDraggingSpectrum) {
              isDraggingSpectrum = false;
              var color = colorState.activeTarget === 'fill' ? colorState.fillColor :
                          colorState.activeTarget === 'stroke' ? colorState.strokeColor :
                          colorState.activeTarget === 'text' ? colorState.textColor : colorState.highlightColor;
              if (color) addToRecentColors(color);
            }
          });
        }
      }

      function drawSpectrum(hue) {
        if (!spectrumCanvas || !spectrumCtx) return;
        var width = spectrumCanvas.width, height = spectrumCanvas.height;
        for (var x = 0; x < width; x++) {
          for (var y = 0; y < height; y++) {
            var s = x / width, v = 1 - (y / height);
            var rgb = hsvToRgb(hue, s, v);
            spectrumCtx.fillStyle = 'rgb(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ')';
            spectrumCtx.fillRect(x, y, 1, 1);
          }
        }
      }

      function pickColorFromSpectrum(e) {
        var rect = spectrumCanvas.getBoundingClientRect();
        var x = Math.max(0, Math.min(e.clientX - rect.left, spectrumCanvas.width - 1));
        var y = Math.max(0, Math.min(e.clientY - rect.top, spectrumCanvas.height - 1));
        var s = x / spectrumCanvas.width, v = 1 - (y / spectrumCanvas.height);
        var rgb = hsvToRgb(colorState.currentHue, s, v);
        var hex = rgbToHex(rgb.r, rgb.g, rgb.b);
        setColor(hex, false);
        updateSpectrumCursor(s, v);
      }

      function updateSpectrumCursor(s, v) {
        var cursor = document.getElementById('spectrumCursor');
        if (!cursor || !spectrumCanvas) return;
        cursor.style.left = (s * spectrumCanvas.width) + 'px';
        cursor.style.top = ((1 - v) * spectrumCanvas.height) + 'px';
      }

      function updateHue(hue) {
        colorState.currentHue = parseInt(hue);
        drawSpectrum(colorState.currentHue);
        var currentColor = colorState.activeTarget === 'fill' ? colorState.fillColor : colorState.strokeColor;
        if (currentColor) {
          var rgb = hexToRgb(currentColor);
          var hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
          var newRgb = hsvToRgb(colorState.currentHue, hsv.s, hsv.v);
          setColor(rgbToHex(newRgb.r, newRgb.g, newRgb.b), false);
        }
      }

      function updateFromRGB() {
        var r = parseInt(document.getElementById('sliderR').value);
        var g = parseInt(document.getElementById('sliderG').value);
        var b = parseInt(document.getElementById('sliderB').value);
        document.getElementById('valueR').value = r;
        document.getElementById('valueG').value = g;
        document.getElementById('valueB').value = b;
        setColor(rgbToHex(r, g, b), false);
      }

      function updateFromRGBInputs() {
        var r = Math.max(0, Math.min(255, parseInt(document.getElementById('valueR').value) || 0));
        var g = Math.max(0, Math.min(255, parseInt(document.getElementById('valueG').value) || 0));
        var b = Math.max(0, Math.min(255, parseInt(document.getElementById('valueB').value) || 0));
        document.getElementById('sliderR').value = r;
        document.getElementById('sliderG').value = g;
        document.getElementById('sliderB').value = b;
        setColor(rgbToHex(r, g, b), false);
      }

      function updateAlphaUI() {
        var sliderVal = parseInt(document.getElementById('sliderA').value);
        var inputVal = parseInt(document.getElementById('valueA').value) || 100;
        // スライダーとインプットを同期（UIのみ更新、適用はしない）
        document.getElementById('sliderA').value = sliderVal;
        document.getElementById('valueA').value = sliderVal;
        colorState.alpha = sliderVal;
        // 塗りのプレビューを更新
        if (colorState.activeTarget === 'fill' && colorState.fillColor) {
          document.getElementById('fillPreview').style.background = hexToRgba(colorState.fillColor, sliderVal / 100);
        }
      }

      function applyCurrentColorWithAlpha() {
        var hexColor, funcName, useAlpha = false;
        if (colorState.activeTarget === 'fill') {
          hexColor = colorState.fillColor;
          funcName = 'setFillColor';
          useAlpha = true;
          // プレビューも更新
          if (hexColor) {
            document.getElementById('fillPreview').style.background = hexToRgba(hexColor, colorState.alpha / 100);
          }
        } else if (colorState.activeTarget === 'stroke') {
          hexColor = colorState.strokeColor;
          funcName = 'setStrokeColor';
          useAlpha = true;
        }
        if (funcName && hexColor && useAlpha) {
          var alpha = colorState.alpha / 100;
          google.script.run[funcName](hexColor, alpha);
        }
      }

      function updateFromHex() {
        var hex = document.getElementById('hexInput').value.replace('#', '');
        if (hex.length === 6 && /^[0-9A-Fa-f]{6}$/.test(hex)) {
          setColor('#' + hex.toUpperCase(), false);
        }
      }

      function addCurrentColorToRecent() {
        var color = colorState.activeTarget === 'fill' ? colorState.fillColor :
                    colorState.activeTarget === 'stroke' ? colorState.strokeColor :
                    colorState.activeTarget === 'text' ? colorState.textColor : colorState.highlightColor;
        if (color) addToRecentColors(color);
      }

      function hexToRgb(hex) {
        if (!hex) return { r: 0, g: 0, b: 0 };
        hex = hex.replace('#', '');
        // 8桁（RRGGBBAA）の場合は6桁に切り詰め
        if (hex.length > 6) hex = hex.substring(0, 6);
        // 3桁（RGB）の場合は6桁に展開
        if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        // 4桁（RGBA）の場合は6桁に
        if (hex.length === 4) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        // 6桁未満は0でパディング
        while (hex.length < 6) hex = hex + '0';
        var r = parseInt(hex.substring(0, 2), 16) || 0;
        var g = parseInt(hex.substring(2, 4), 16) || 0;
        var b = parseInt(hex.substring(4, 6), 16) || 0;
        return { r: r, g: g, b: b };
      }

      function rgbToHex(r, g, b) {
        return '#' + [r, g, b].map(function(x) { var h = x.toString(16); return h.length === 1 ? '0' + h : h; }).join('').toUpperCase();
      }

      function hexToRgba(hex, alpha) {
        var rgb = hexToRgb(hex);
        return 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + alpha + ')';
      }

      function rgbToHsv(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        var max = Math.max(r, g, b), min = Math.min(r, g, b), h, s, v = max, d = max - min;
        s = max === 0 ? 0 : d / max;
        if (max === min) { h = 0; }
        else { switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; }
        return { h: Math.round(h * 360), s: s, v: v };
      }

      function hsvToRgb(h, s, v) {
        var r, g, b, i = Math.floor(h / 60) % 6, f = h / 60 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
        switch (i) { case 0: r = v; g = t; b = p; break; case 1: r = q; g = v; b = p; break; case 2: r = p; g = v; b = t; break; case 3: r = p; g = q; b = v; break; case 4: r = t; g = p; b = v; break; case 5: r = v; g = p; b = q; break; }
        return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
      }

      function toggleEyedropper() {
        var btn = document.getElementById('eyedropperBtn');
        if (btn.classList.contains('active')) { btn.classList.remove('active'); }
        else {
          btn.classList.add('active');
          google.script.run
            .withSuccessHandler(function(result) {
              if (result) {
                if (colorState.activeTarget === 'fill' && result.fillColor) setColor(result.fillColor, true);
                else if (colorState.activeTarget === 'stroke' && result.strokeColor) setColor(result.strokeColor, true);
                else if (colorState.activeTarget === 'text' && result.textColor) setColor(result.textColor, true);
                else if (colorState.activeTarget === 'highlight' && result.backgroundColor) setColor(result.backgroundColor, true);
              }
              btn.classList.remove('active');
            })
            .withFailureHandler(function(e) { showToast(e.message, 'error'); btn.classList.remove('active'); })
            .getSelectedElementColors(currentLang);
        }
      }

      // ==========================================
      // 枠線スタイル機能
      // ==========================================
      function setDashStyle(style, el) {
        colorState.strokeDashStyle = style;
        document.querySelectorAll('.dash-option').forEach(function(opt) { opt.classList.remove('selected'); });
        el.classList.add('selected');
      }

      function applyStrokeStyle() {
        colorState.strokeWeight = parseFloat(document.getElementById('strokeWeight').value) || 1;
        google.script.run.setStrokeStyle(colorState.strokeWeight, colorState.strokeDashStyle, currentLang);
      }

      // ==========================================
      // 位置変更機能
      // ==========================================
      function applyPositionX() {
        var x = parseFloat(document.getElementById('positionX').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setElementPositionX(x, currentLang);
      }

      function applyPositionY() {
        var y = parseFloat(document.getElementById('positionY').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setElementPositionY(y, currentLang);
      }

      // ==========================================
      // サイズ変更機能
      // ==========================================
      function applyWidth() {
        var width = parseFloat(document.getElementById('sizeWidth').value);
        var keepRatio = document.getElementById('keepAspectRatio').checked;
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setElementWidth(width, keepRatio, currentLang);
      }

      function applyHeight() {
        var height = parseFloat(document.getElementById('sizeHeight').value);
        var keepRatio = document.getElementById('keepAspectRatio').checked;
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setElementHeight(height, keepRatio, currentLang);
      }

      function matchWidth() {
        var reference = document.getElementById('alignReference').value;
        google.script.run
          .withSuccessHandler(function(r) { showToast(r, 'success'); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .matchElementsWidth(reference, currentLang);
      }
      function matchHeight() {
        var reference = document.getElementById('alignReference').value;
        google.script.run
          .withSuccessHandler(function(r) { showToast(r, 'success'); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .matchElementsHeight(reference, currentLang);
      }
      function matchSize() {
        var reference = document.getElementById('alignReference').value;
        google.script.run
          .withSuccessHandler(function(r) { showToast(r, 'success'); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .matchElementsSize(reference, currentLang);
      }

      function setAspectRatio(widthRatio, heightRatio) {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setElementAspectRatio(widthRatio, heightRatio, currentLang);
      }

      // ==========================================
      // 間隔調整機能
      // ==========================================
      function setHorizontalSpacing() {
        var spacing = parseFloat(document.getElementById('spacingValue').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setHorizontalSpacing(spacing, currentLang);
      }

      function setVerticalSpacing() {
        var spacing = parseFloat(document.getElementById('spacingValue').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setVerticalSpacing(spacing, currentLang);
      }

      // ==========================================
      // 複製機能
      // ==========================================
      function duplicateHorizontal() {
        var count = parseInt(document.getElementById('duplicateCount').value);
        var spacing = parseFloat(document.getElementById('duplicateSpacing').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .duplicateHorizontal(count, spacing, currentLang);
      }

      function duplicateVertical() {
        var count = parseInt(document.getElementById('duplicateCount').value);
        var spacing = parseFloat(document.getElementById('duplicateSpacing').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .duplicateVertical(count, spacing, currentLang);
      }

      function duplicateGrid() {
        var count = parseInt(document.getElementById('duplicateCount').value);
        var spacing = parseFloat(document.getElementById('duplicateSpacing').value);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .duplicateGrid(count, spacing, currentLang);
      }

      // ==========================================
      // 回転・反転機能
      // ==========================================
      function rotate90CW() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .rotateElement(90, currentLang);
      }
      function rotate90CCW() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .rotateElement(-90, currentLang);
      }
      function rotate180() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .rotateElement(180, currentLang);
      }
      function flipHorizontal() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .flipHorizontal(currentLang);
      }
      function flipVertical() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .flipVertical(currentLang);
      }

      // ==========================================
      // 順序変更機能
      // ==========================================
      function bringToFront() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .bringToFront(currentLang);
      }
      function bringForward() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .bringForward(currentLang);
      }
      function sendBackward() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .sendBackward(currentLang);
      }
      function sendToBack() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .sendToBack(currentLang);
      }

      // ==========================================
      // グループ化機能
      // ==========================================
      function groupElements() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .groupElements(currentLang);
      }
      function ungroupElements() {
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .ungroupElements(currentLang);
      }

      // ==========================================
      // 類似オブジェクト選択機能
      // ==========================================
      var currentElementAttrs = null;

      function updateSimilarPanel() {
        google.script.run
          .withSuccessHandler(function(attrs) {
            currentElementAttrs = attrs;
            updateSimilarButtons(attrs);
          })
          .withFailureHandler(function(e) {
            currentElementAttrs = null;
            updateSimilarButtons(null);
          })
          .getSelectedElementAttributes(currentLang);
      }

      function updateSimilarButtons(attrs) {
        var statusDiv = document.getElementById('similarAttrs');
        var btnFill = document.getElementById('btnSimilarFill');
        var btnStroke = document.getElementById('btnSimilarStroke');
        var btnTextColor = document.getElementById('btnSimilarTextColor');
        var btnFont = document.getElementById('btnSimilarFont');
        var btnFontSize = document.getElementById('btnSimilarFontSize');
        var btnStrokeWeight = document.getElementById('btnSimilarStrokeWeight');

        if (!attrs) {
          statusDiv.textContent = 'Select an object';
          btnFill.disabled = true;
          btnStroke.disabled = true;
          btnTextColor.disabled = true;
          btnFont.disabled = true;
          btnFontSize.disabled = true;
          btnStrokeWeight.disabled = true;
          document.getElementById('previewFill').style.background = '#ccc';
          document.getElementById('previewStroke').style.borderColor = '#ccc';
          document.getElementById('previewTextColor').style.color = '#ccc';
          document.getElementById('previewFont').textContent = 'Aa';
          document.getElementById('previewFontSize').textContent = '--';
          document.getElementById('previewStrokeWeight').textContent = '--';
          return;
        }

        statusDiv.textContent = attrs.elementType + ' selected';

        // 塗りつぶし色
        if (attrs.fillColor) {
          btnFill.disabled = false;
          document.getElementById('previewFill').style.background = attrs.fillColor;
        } else {
          btnFill.disabled = true;
          document.getElementById('previewFill').style.background = '#ccc';
        }

        // 枠線色
        if (attrs.strokeColor) {
          btnStroke.disabled = false;
          document.getElementById('previewStroke').style.borderColor = attrs.strokeColor;
        } else {
          btnStroke.disabled = true;
          document.getElementById('previewStroke').style.borderColor = '#ccc';
        }

        // 文字色
        if (attrs.textColor) {
          btnTextColor.disabled = false;
          document.getElementById('previewTextColor').style.color = attrs.textColor;
        } else {
          btnTextColor.disabled = true;
          document.getElementById('previewTextColor').style.color = '#ccc';
        }

        // フォント
        if (attrs.fontFamily) {
          btnFont.disabled = false;
          document.getElementById('previewFont').textContent = attrs.fontFamily.substring(0, 6);
        } else {
          btnFont.disabled = true;
          document.getElementById('previewFont').textContent = 'Aa';
        }

        // フォントサイズ
        if (attrs.fontSize) {
          btnFontSize.disabled = false;
          document.getElementById('previewFontSize').textContent = Math.round(attrs.fontSize);
        } else {
          btnFontSize.disabled = true;
          document.getElementById('previewFontSize').textContent = '--';
        }

        // 枠線の太さ
        if (attrs.strokeWeight) {
          btnStrokeWeight.disabled = false;
          document.getElementById('previewStrokeWeight').textContent = attrs.strokeWeight.toFixed(1);
        } else {
          btnStrokeWeight.disabled = true;
          document.getElementById('previewStrokeWeight').textContent = '--';
        }
      }

      function selectSimilar(matchType) {
        google.script.run
          .withSuccessHandler(function(result) {
            showToast(result.message, result.count > 0 ? 'success' : 'info');
          })
          .withFailureHandler(function(e) {
            showToast(e.message, 'error');
          })
          .selectSimilarElements(matchType, currentLang);
      }

      // ==========================================
      // 書式・スタイルコピー履歴機能
      // ==========================================
      var styleHistory = [];
      var MAX_STYLE_HISTORY = 10;

      function loadStyleHistory() {
        try {
          var saved = localStorage.getItem('styleHistory');
          if (saved) {
            styleHistory = JSON.parse(saved);
            renderStyleHistory();
          }
        } catch(e) {}
      }

      function saveStyleHistory() {
        try {
          localStorage.setItem('styleHistory', JSON.stringify(styleHistory));
        } catch(e) {}
      }

      function copyCurrentStyle() {
        google.script.run
          .withSuccessHandler(function(style) {
            styleHistory.unshift(style);
            if (styleHistory.length > MAX_STYLE_HISTORY) {
              styleHistory.pop();
            }
            saveStyleHistory();
            renderStyleHistory();
            showToast(t('msg_style_copied'), 'success');
          })
          .withFailureHandler(function(e) {
            showToast(e.message, 'error');
          })
          .copyElementStyle(currentLang);
      }

      function renderStyleHistory() {
        var container = document.getElementById('styleHistoryList');
        if (styleHistory.length === 0) {
          container.innerHTML = '<div style="color:#5f6368;font-size:12px;text-align:center;padding:20px 0;">' + t('label_no_history') + '</div>';
          return;
        }

        var html = '';
        for (var i = 0; i < styleHistory.length; i++) {
          var style = styleHistory[i];
          var previewHtml = '';

          if (style.fillColor) {
            previewHtml += '<span style="display:inline-block;width:14px;height:14px;background:' + style.fillColor + ';border-radius:2px;vertical-align:middle;margin-right:3px;border:1px solid #ddd;"></span>';
          }
          if (style.strokeColor) {
            previewHtml += '<span style="display:inline-block;width:14px;height:14px;border:2px solid ' + style.strokeColor + ';border-radius:2px;vertical-align:middle;margin-right:3px;box-sizing:border-box;"></span>';
          }
          if (style.textColor) {
            previewHtml += '<span style="color:' + style.textColor + ';font-weight:bold;margin-right:3px;">A</span>';
          }
          if (style.backgroundColor) {
            previewHtml += '<span style="display:inline-block;background:' + style.backgroundColor + ';color:#000;font-weight:bold;padding:0 3px;border-radius:2px;margin-right:3px;font-size:11px;">A</span>';
          }

          var labelParts = [];
          if (style.fontFamily) labelParts.push(style.fontFamily.substring(0, 10));
          if (style.fontSize) labelParts.push(style.fontSize + 'pt');
          var labelText = labelParts.join(' ');

          html += '<div class="style-history-item" data-index="' + i + '" style="display:flex;align-items:center;padding:8px;border:1px solid #dadce0;border-radius:4px;margin-bottom:6px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background=\'#f8fbff\'" onmouseout="this.style.background=\'#fff\'">';
          html += '<div style="flex:1;display:flex;align-items:center;">' + previewHtml + '<span style="font-size:11px;color:#5f6368;">' + labelText + '</span></div>';
          html += '<button onclick="applyStyleFromHistory(' + i + ');event.stopPropagation();" style="background:#1a73e8;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">適用</button>';
          html += '<button onclick="removeStyleFromHistory(' + i + ');event.stopPropagation();" style="background:none;border:none;color:#5f6368;padding:4px;cursor:pointer;margin-left:4px;font-size:14px;">x</button>';
          html += '</div>';
        }
        container.innerHTML = html;
      }

      function applyStyleFromHistory(index) {
        var style = styleHistory[index];
        if (!style) return;

        google.script.run
          .withSuccessHandler(function(result) {
            showToast(result, 'success');
          })
          .withFailureHandler(function(e) {
            showToast(e.message, 'error');
          })
          .applyElementStyle(style, { all: true }, currentLang);
      }

      function removeStyleFromHistory(index) {
        styleHistory.splice(index, 1);
        saveStyleHistory();
        renderStyleHistory();
      }

      function clearStyleHistory() {
        styleHistory = [];
        saveStyleHistory();
        renderStyleHistory();
        showToast(t('msg_history_cleared'), 'info');
      }

      // ==========================================
      // テキスト機能
      // ==========================================
      var textState = { font: 'Arial', size: 14, bold: false, italic: false, underline: false, strikethrough: false };

      function applyFont() {
        textState.font = document.getElementById('fontSelect').value;
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setTextFont(textState.font, currentLang);
      }

      function applyFontSize() {
        textState.size = parseInt(document.getElementById('fontSizeInput').value) || 14;
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setTextFontSize(textState.size, currentLang);
      }

      function toggleTextStyle(style) {
        var btn, funcName;
        switch(style) {
          case 'bold': textState.bold = !textState.bold; btn = document.getElementById('btnBold'); funcName = 'setTextBold'; break;
          case 'italic': textState.italic = !textState.italic; btn = document.getElementById('btnItalic'); funcName = 'setTextItalic'; break;
          case 'underline': textState.underline = !textState.underline; btn = document.getElementById('btnUnderline'); funcName = 'setTextUnderline'; break;
          case 'strikethrough': textState.strikethrough = !textState.strikethrough; btn = document.getElementById('btnStrikethrough'); funcName = 'setTextStrikethrough'; break;
        }
        btn.classList.toggle('active', textState[style]);
        google.script.run
          .withSuccessHandler(function(r) { console.log('成功:', r); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          [funcName](textState[style], currentLang);
      }

      function setLineSpacing(value) {
        document.getElementById('lineSpacing').value = value;
        applyLineSpacing();
      }

      function applyLineSpacing() {
        var spacing = parseFloat(document.getElementById('lineSpacing').value) || 1;
        google.script.run
          .withSuccessHandler(function(r) { showToast(r, 'success'); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setLineSpacing(spacing, currentLang);
      }

      function applyParagraphSpacing() {
        var before = parseFloat(document.getElementById('spaceBefore').value) || 0;
        var after = parseFloat(document.getElementById('spaceAfter').value) || 0;
        google.script.run
          .withSuccessHandler(function(r) { showToast(r, 'success'); })
          .withFailureHandler(function(e) { showToast(e.message, 'error'); })
          .setParagraphSpacing(before, after, currentLang);
      }

      // ==========================================
      // ドラッグ＆ドロップによるセクション並び替え
      // ==========================================
      var draggedSection = null;
      var draggedGroup = null;

      function initDragAndDrop() {
        // セクションにドロップ先としてのイベントを設定
        var sections = document.querySelectorAll('.section[data-group]');
        sections.forEach(function(section) {
          section.addEventListener('dragover', handleDragOver);
          section.addEventListener('dragenter', handleDragEnter);
          section.addEventListener('dragleave', handleDragLeave);
          section.addEventListener('drop', handleDrop);
        });

        // ヘッダー部分のみをドラッグ可能にする
        var headers = document.querySelectorAll('.section-header');
        headers.forEach(function(header) {
          header.setAttribute('draggable', 'true');
          header.addEventListener('dragstart', handleDragStart);
          header.addEventListener('dragend', handleDragEnd);
        });

        // 保存された順序を復元
        loadSectionOrder();
      }

      function handleDragStart(e) {
        // ヘッダーの親要素（section）を取得
        var section = this.closest('.section');
        if (!section) return;

        draggedSection = section;
        draggedGroup = section.getAttribute('data-group');
        section.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', section.id);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      }

      function handleDragEnter(e) {
        e.preventDefault();
        if (this !== draggedSection && this.getAttribute('data-group') === draggedGroup) {
          this.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        this.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');

        if (this !== draggedSection && this.getAttribute('data-group') === draggedGroup) {
          var parent = this.parentNode;
          var allSections = Array.from(parent.querySelectorAll('.section[data-group="' + draggedGroup + '"]'));
          var draggedIdx = allSections.indexOf(draggedSection);
          var targetIdx = allSections.indexOf(this);

          if (draggedIdx < targetIdx) {
            parent.insertBefore(draggedSection, this.nextSibling);
          } else {
            parent.insertBefore(draggedSection, this);
          }
          saveSectionOrder();
        }
      }

      function handleDragEnd(e) {
        // ヘッダーから呼ばれるので、親のsectionからdraggingを削除
        var section = this.closest('.section');
        if (section) {
          section.classList.remove('dragging');
        }
        document.querySelectorAll('.section').forEach(function(s) {
          s.classList.remove('drag-over');
        });
        draggedSection = null;
        draggedGroup = null;
      }

      function saveSectionOrder() {
        var groups = ['image', 'utility'];
        var order = {};
        groups.forEach(function(group) {
          var sections = document.querySelectorAll('.section[data-group="' + group + '"]');
          order[group] = Array.from(sections).map(function(s) { return s.id; });
        });
        localStorage.setItem('sectionOrder', JSON.stringify(order));
      }

      function loadSectionOrder() {
        var saved = localStorage.getItem('sectionOrder');
        if (!saved) return;
        try {
          var order = JSON.parse(saved);
          ['image', 'utility'].forEach(function(group) {
            if (!order[group]) return;
            var container = document.querySelector('.section[data-group="' + group + '"]');
            if (!container) return;
            container = container.parentNode;
            order[group].forEach(function(id) {
              var section = document.getElementById(id);
              if (section && section.getAttribute('data-group') === group) {
                container.appendChild(section);
              }
            });
          });
        } catch (e) {
          console.log('Failed to load section order:', e);
        }
      }

      // 初期化
      document.addEventListener('DOMContentLoaded', initDragAndDrop);

      // ==========================================
      // フィードバック送信
      // ==========================================
      function openFeedback() {
        window.open('https://haruniko-app.github.io/Designers-palette/feedback-ja.html', '_blank');
      }

    </script>
    </body>
</html>
